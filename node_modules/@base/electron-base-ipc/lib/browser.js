"use strict";const{EventEmitter:EventEmitter}=require("events"),{ipcMain:ipcMain,BrowserWindow:BrowserWindow}=require("electron"),{WindowSender:WindowSender,EventSender:EventSender}=require("./sender"),{MessageEvent:MessageEvent,serializeError:serializeError,deserializeError:deserializeError}=require("./event"),pkg=require("../package.json"),ipcFlag=`${pkg.name}@${pkg.version}`;class BaseIpc extends EventEmitter{broadcast(e,...r){let n={message:e,arguments:r};BrowserWindow.getAllWindows().forEach(e=>{e.isDestroyed()||e.send(`${ipcFlag}:broadcast`,n)})}emit(e,...r){let n=this._events[e];return n||(n=[]),Array.isArray(n)||(n=[n]),new EventSender(n,{message:e,arguments:r})}sendToWin(e,r,...n){return new WindowSender(e,{message:r,arguments:n})}}module.exports=new BaseIpc,ipcMain.on(`${ipcFlag}:send`,(e,r)=>{let n=new MessageEvent("renderer");n.sender=e.sender,r.needCallback&&(n.needCallback=!0,n.reply=function(n,...s){!n||n instanceof Error||console.log(`${r.message} - The first parameter of event.reply must be 'Error'`),e.sender.isDestroyed()||e.sender.send(`${ipcFlag}:send-reply`,r.cid,serializeError(n),JSON.stringify(s||[]))}),EventEmitter.prototype.emit.call(module.exports,r.message,n,...r.arguments)}),ipcMain.on(`${ipcFlag}:sendSync`,async(e,r)=>{let n=new MessageEvent("renderer");n.sender=e.sender;let s=module.exports._events[r.message];if(s){Array.isArray(s)||(s=[s]);try{const t=await s[0](n,...r.arguments);e.returnValue={error:null,value:t}}catch(r){e.returnValue={error:serializeError(r),value:null}}for(let e=1;e<s.length;e++){let t=s[e];await t(n,...r.arguments)}}else e.returnValue=Object.create(null)}),ipcMain.on(`${ipcFlag}:send-reply`,(e,r,n,s)=>{let t=WindowSender.query(r);t?(clearTimeout(t._timer),t._callback&&t._callback(deserializeError(n),...JSON.parse(s)),WindowSender.remove(r)):console.warn("Sender does not exist")});