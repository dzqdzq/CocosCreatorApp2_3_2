"use strict";const{promisify:i}=require("util"),t=require("path"),e=require("electron"),r=require("fire-fs"),o=require("semver"),n=e.ipcMain;process.on("unhandledRejection",i=>{console.error(i)}),exports.startup=async function(n,l){if(require("./init"),global.Editor=require("./lib/editor"),await Editor.Network.update(),Editor.Network.isOnline&&!Editor.argv.nologin||Editor.User.enable(!1),!Editor.argv._command)try{let i=await Editor.Project.check();if(i&&i.abort)return e.app.quit(),void 0;await Editor.Project.init()}catch(i){return l(i),void 0}await d(),"string"!=typeof Editor._buildCommand&&"string"!=typeof Editor._compileCommand&&await i(a)();try{await Editor.Engine.build()}catch(i){await Editor.Engine.revertEngineDialog(i),await Editor.Engine.build()}try{await Editor.Engine.init(),await Editor.Engine.initExtends()}catch(i){return await Editor.Engine.revertEngineDialog(i,Editor.T("EDITOR_MAIN.init_engine_extends_failed"),Editor.T("EDITOR_MAIN.init_engine_extends_failed_detail")),l(i)}(function(){let i,e=t.join(Editor.Project.path,"project.json");try{i=r.readJsonSync(e)}catch(i){return console.error(i)}let n=i.version;if((!n||o.satisfies(n,"< "+Editor.versions.CocosCreator,{includePrerelease:!0}))&&(console.log("migrating project from "+(n||"< 2.1.2")),Editor.Ipc.sendToMain("migrate-project",n)),i.version=Editor.versions.CocosCreator,!i.id){const t=require("node-uuid");i.id=t.v4()}try{r.writeFileSync(e,JSON.stringify(i,null,2))}catch(i){console.error(i)}})(),function(){try{const i=Editor.Profile.load("global://settings.json");if(!i.get("simulator-customsize-resolution")){const t=require("../share/engine-utils"),e=i.get("use-default-cpp-engine"),r=t.getSimulatorConfigAt(!e&&i.get("cpp-engine-path")).init_cfg;i.set("simulator-customsize-resolution",{width:r.width,height:r.height}),i.save()}}catch(i){console.error(i)}}();try{await s()}catch(i){return await Editor.Engine.revertEngineDialog(i,Editor.T("EDITOR_MAIN.register_builtin_assets_failed"),Editor.T("EDITOR_MAIN.register_builtin_assets_failed_detail")),l(i)}try{Editor.AssetDB.loading=!0,await Editor.AssetDB.mountInternal(),await Editor.AssetDB.mountExternal(),await Editor.AssetDB.mountMain(),await Editor.AssetDB.init(),Editor.AssetDB.loading=!1}catch(i){return Editor.AssetDB.loading=!1,l(i)}let c=require("../share/engine-utils");Editor.builtinCocosRoot=c.getEnginePath();try{await Editor.Engine.initSceneList()}catch(i){return l(i)}const u=require("./share/build-jsb-adapter");return await u.prebuild({rootPath:Editor.url("packages://jsb-adapter"),dstPath:Editor.url("packages://jsb-adapter/bin")}),await Editor.ProjectCompiler.init(),"string"==typeof Editor._buildCommand?(await new Promise((i,t)=>{Editor.Builder.buildCommand(Editor._buildCommand,r=>{if(r)return Editor.error(r),e.app.exit(1),t(r),void 0;e.app.quit(),i()})}),void 0):"string"==typeof Editor._compileCommand?(await new Promise((i,t)=>{Editor.Builder.compileCommand(Editor._compileCommand,r=>{if(r)return Editor.error(r),e.app.exit(1),t(r),void 0;e.app.quit(),i()})}),void 0):(l(),void 0)};let a=function(i){Editor.Window.initWindowStates("local://layout.editor.json","default://layout.editor.json"),Editor.run("app://editor/index.html",{title:"Cocos Creator",width:1280,height:720,minWidth:100,minHeight:100,show:!1,resizable:!0});var t=Editor.Window.main;t.nativeWin.on("close",function(){t.closing=!0}),n.on("app:is-main-window-attemp-to-close",i=>{i.returnValue=!!t.closing,t.closing=!1}),t.nativeWin.webContents.once("did-finish-load",function(){i&&i()})},d=async function(){Editor.argv._command||await i(Editor.loadAllPackages)()},s=function(){Editor.argv._command||(require("./share/register-builtin-assets"),require("./core/init-builtin-assets"))};