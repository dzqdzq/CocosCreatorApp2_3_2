const e=require("fire-path"),t=require("globby"),r=require("async"),i=require("fire-url"),o=require("lodash"),n=Editor.remote.ProjectCompiler.DEST_PATH,l=e.join(Editor.remote.Project.path,"node_modules");let a=Object.create(null),s=[];let d=Editor.Profile.load("global://features.json").get("show-circular-import-warning")||!1,u=require("module"),c=0,p=[];function m(t){let r=e.basenameNoExt(t);delete require.cache[t],delete a[r]}function f(e){p.length=0;try{require(e)}catch(t){Editor.failed(`load script [${e}] failed : ${t.stack}`)}}cc.require=function(t,r){let i;r=r||require,c++;try{i=r(t)}catch(e){Editor.failed(`load script [${t}] failed : ${e.stack}`)}let o=p[c-1];if(o&&d){let t=p.indexOf(o);if(t!==c-1){let r=[];for(let i=t;i<p.length;i++)r.push("  "+e.relative(n,p[i]));Editor.warn("Circular import modules => \n"+r.join("\n"))}}return c--,i},u._resolveFilenameVendor=u._resolveFilename,u._resolveFilename=function(t,r,i){if(c>0){let i=e.basename(t);i.endsWith(".js")&&(i=i.slice(0,-3));let o=a[i];if(!function(e){return-1!==e.replace(/\\/g,"/").indexOf("/node_modules/")}(r.filename)&&o)return p[c-1]=o.path,o.path}return r.paths.includes(l)||r.paths.push(l),u._resolveFilenameVendor(t,r,i)};let h=[];module.exports={getPluginScriptUuidByPath:e=>h[e],load:function(e){r.series([this.loadPlugins.bind(this),this.loadCommon.bind(this)],e)},loadScript:function(e,t){var r=document.createElement("script");r.onload=function(){r.remove(),t()},r.onerror=function(){r.remove(),Editor.error("Failed to load %s",e),t(new Error("Failed to load "+e))},r.setAttribute("type","text/javascript"),r.setAttribute("charset","utf-8");let o=Editor.remote.assetdb.fspathToUuid(e.replace("disable-commonjs://",""));e=i.addRandomQuery(e),h[e]=o,r.setAttribute("src",e),document.head.appendChild(r)},loadPlugins:function(t){console.time("query plugin scripts"),Editor.Ipc.sendToMain("app:query-plugin-scripts","editor",(i,o)=>{if(console.timeEnd("query plugin scripts"),i)return t(i);s=o.map(t=>e.stripSep(t)),h.length=0,r.eachSeries(o,(e,t)=>{this.loadScript("disable-commonjs://"+e,t)},t)},6e5)},loadCommon:function(r){for(let e in a){m(a[e].path)}a={};let i=[e.join(n,"/**/*.js"),"!"+e.join(n,"__node_modules/**")];t(i,(t,i)=>{(i=o(i).map(t=>e.stripSep(t)).filter(e=>-1===s.indexOf(e)).sortBy().value()).forEach(t=>{(function(t,r){r=r||e.basenameNoExt(t);let i=a[r];return i||(i=a[r]={name:r,path:t,children:[]}),i})(t)}),c++;for(let e=0;e<i.length;e++)f(i[e]);c--,r&&r()})}};