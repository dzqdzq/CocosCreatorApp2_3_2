const e=require("util");let t=cc.MaterialVariant.prototype;t._init=t.init,t.init=function(e){this._init(e);let t=i.materialVariants;t[e._uuid]||(t[e._uuid]=[]),t[e._uuid].push(this)},(t=cc.Material.prototype)._onLoad=t.onLoad,t.onLoad=function(){this._onLoad(),i.materials[this._uuid]=this},cc.director.on(cc.Director.EVENT_BEFORE_SCENE_LOADING,()=>{i.materials={},i.materialVariants={}});let i=module.exports={materials:{},materialVariants:{},onEffectReload(e){for(let t in i.materials){let a=i.materials[t];a.effect&&a.effect._asset.uuid===e.uuid&&delete i.materials[t]}},updateVariants(e){let t=i.materialVariants[e._uuid];if(t)for(let i=0;i<t.length;i++){t[i]._init(e);let a=t[i].owner;a&&a._updateMaterial&&a._updateMaterial()}},cloneMaterial(e){let t=new cc.Material;t._uuid=e._uuid,e._effect&&(t._effect=e._effect.clone(),t._effectAsset=e._effectAsset),t._techniqueIndex=e._techniqueIndex;let i=e._techniqueData,a={};for(let e in i){let t=i[e];if(!t)continue;let s={};if(t.props){s.props={};for(let e in t.props){let i=t.props[e];i.clone&&(i=i.clone()),s.props[e]=i}}t.defines&&(s.defines=Object.assign({},t.defines)),a[e]=s}return t._techniqueData=a,t},switchEffectOrTechnique(e,t,a,s){let r=!1;if(e.effectName!==a&&(e.effectName=a,r=!0),e.techniqueIndex!==s&&(e.techniqueIndex=s,r=!0),!r)return;let n=t._techniqueData,l={};for(let t in n){let i=l[t]={},a=n[t].props;if(a){i.props={};for(let s in a)void 0!==e.getProperty(s,t)&&(i.props[s]=a[s],e.setProperty(s,a[s],t))}let s=n[t].defines;if(s){i.defines={};for(let a in s)void 0!==e.getDefine(a,t)&&(i.defines[a]=s[a],e.define(a,s[a],t))}}e._techniqueData=l,i.updateVariants(e)},updateInspectorMaterialValue(e,t){let i=e.value;if("props"===e.type)if(e.assetType){let s=i&&(i.uuid||i._uuid);if(s)return cc.AssetLibrary.loadAsset(s,(s,r)=>{if(s)return Editor.error(s),void 0;t.setProperty(e.name,r,e.passIdx),i=r,a()}),void 0;t.setProperty(e.name,null,e.passIdx)}else e.valueCtor.clone&&(i=e.valueCtor.clone(e.value)),t.setProperty(e.name,i,e.passIdx);else t.define(e.name,i,e.passIdx);function a(){let a=t._techniqueData;a[e.passIdx]||(a[e.passIdx]={props:{},defines:{}});let s=a[e.passIdx];s[e.type]||(s[e.type]={}),s[e.type][e.name]=i}a(),cc.engine.repaintInEditMode()},async getInspectorAsset(t){let a=i.materials[t];return a||(a=await e.promisify(cc.AssetLibrary.loadAsset)(t)),{asset:a,resetAsset:this.cloneMaterial(a)}},resetInspectorAsset(e){i.materials[e._uuid]=e,i.updateVariants(e),cc.engine.repaintInEditMode()}};