const e=require("fire-fs"),r=require("fire-path"),n=require("convert-source-map"),i=require("../../../page/refine-sourcemap"),{formatPath:o}=require("../utils"),t="undefined"!=typeof Editor?Editor.url("unpack://editor/share/quick-compile/plugins/__quick_compile__.js"):r.join(__dirname,"__quick_compile__.js"),u=e.readFileSync(t,"utf8");module.exports=function(t){t.prefix=t.prefix||"",t.modularName=t.modularName?`__quick_compile_${t.modularName}__`:"__quick_compile__";let _=function(e,n,i){let u;return u=t.transformPath?t.transformPath(e,n,i):r.join(t.prefix||"",r.relative(i.out,n)),o(u)},s=t.excludes||[];Array.isArray(s)||(s=[s]),s=s.map(e=>o(e));let m=t.requireInNodeEnv||"require",c=t.modularName;return{nodeModule:!0,transform(e,o){let{src:u,dst:s,source:l}=e,a=`\n                (function() {\n                    var nodeEnv = typeof require !== 'undefined' && typeof process !== 'undefined';\n                    var __module = nodeEnv ? module : {exports:{}};\n                    var __filename = '${_(u,s,o)}';\n                    var __require = nodeEnv ? function (request) {\n                        return ${m}(request);\n                    } : function (request) {\n                        return ${c}.require(request, __filename);\n                    };\n                    function __define (exports, require, module) {\n                        if (!nodeEnv) {${c}.registerModule(__filename, module);}`,d=`\n                    }\n                    if (nodeEnv) {\n                        __define(__module.exports, __require, __module);\n                    }\n                    else {\n                        ${c}.registerModuleFunc(__filename, function () {\n                            __define(__module.exports, __require, __module);\n                        });\n                    }\n                })();`,f=!0;if(".json"===r.extname(u)?(l="module.exports = "+l,f=!1):t.exludesForSourceMap&&t.exludesForSourceMap.includes(u)&&(f=!1),f){let e=n.fromSource(l);e?(e=e.toObject(),e=i.offsetLines(e,a.match(/\n/g).length),mapComment=n.fromObject(e).toComment(),l=a+l.replace(/\n\/\/# sourceMappingURL.*/,"")+d+"\n"+mapComment):f=!1}f||(l=a+l+d),e.source=l},async compileFinished(n){let i=n.getSortedScripts(),o=(i=i.filter(e=>-1===s.indexOf(e.src))).map(e=>{let r={};for(let n in e.deps)r[n]=i.findIndex(function(r){return r.src===e.deps[n]});return{mtime:n._mtimes[e.src],deps:r,path:_(e.src,e.dst,n)}}),m=n.entries.map(e=>_(e,n.getDstPath(e),n)),c=function(e,r,n){let i=u.replace(/{prefix}/g,n.prefix);return`\n(function () {\nvar scripts = ${e};\nvar entries = ${r};\n\n${i=i.replace(/__quick_compile__/g,n.modularName)}\n})();\n    `}(JSON.stringify(o),JSON.stringify(m),t);e.writeFileSync(r.join(n.out,"__quick_compile__.js"),c)}}};