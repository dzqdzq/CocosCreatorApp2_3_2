const t=require("fire-path"),e=require("fire-fs"),i=require("globby"),r=require("lodash"),s=require("del"),o=require("convert-source-map"),a=require("./index.js"),{formatPath:c}=require("./utils"),n=require("./plugins/module"),p=require("./plugins/insert-globals"),l=t.join(Editor.Project.path,"temp/quick-scripts"),h=t.join(l,"src"),d=t.join(l,"dst"),u=t.join(Editor.Project.path,"library/imports"),m=t.join(h,"__qc_index__.js");function f(){Editor.Ipc.sendToWins("scene:soft-reload",!0)}f=r.debounce(f,300);let w={name2PathMap:{},errorScripts:{},DEST_PATH:d,async init(){console.time("Init project script"),function(){try{s.sync(l,{force:!0})}catch(t){Editor.error(t)}}(),this.copyAllImportsToSrc(),this.rebuildIndex(),await this.createCompiler(),console.timeEnd("Init project script")},async removeScripts(t){t.forEach(t=>{let e=Editor.assetdb.fspathToUuid(t);if(!this.isPlugin(e)){let e=this.raw2src(t);s.sync(e,{force:!0});let i=this.raw2dest(t);s.sync(i,{force:!0}),this.compiler.removeCachedScripts(e)}}),await this.rebuild()},async moveScripts(t,i){t.forEach(t=>{let e=Editor.assetdb.fspathToUuid(t);if(!this.isPlugin(e)){let e=this.raw2src(t);s.sync(e,{force:!0});let i=this.raw2dest(t);s.sync(i,{force:!0}),this.compiler.removeCachedScripts(e)}});let r=[];i.forEach(t=>{let i=Editor.assetdb.fspathToUuid(t);if(!this.isPlugin(i)){let i=this.raw2src(t),s=this.raw2import(t);e.copySync(s,i),r.push(i)}}),await this.rebuild(r)},async compileScripts(t){let i=[];t.forEach(t=>{this.singleScriptCompileSuccess(t);let r=Editor.assetdb.fspathToUuid(t);if(!this.isPlugin(r)){let r=this.raw2src(t),s=this.raw2import(t);e.copySync(s,r),i.push(r)}}),await this.rebuild(i)},singleScriptCompileFailed(t){let e=this.errorScripts[t.uuid];e||(e=this.errorScripts[t.uuid]=[]),e.push(t.error.toString())},singleScriptCompileSuccess(t){let e=Editor.assetdb.fspathToUuid(t),i=this.errorScripts[e];i&&(i.forEach(t=>{Editor.clearLog(t)}),delete this.errorScripts[e])},async createCompiler(){this.compiler=new a;let t=this,i={root:h,entries:m,out:d,plugins:[{transform(i,r){let s=t.dest2import(i.dst)+".map";if(e.existsSync(s)){let t=e.readJsonSync(s),r=o.fromObject(t).toComment();i.source=i.source+"\n"+r}},resolve(e,i){if(!/^[\w- .]*$/.test(e))return;let r=e.replace(/\.(?:js|ts|json)$/i,""),s=t.name2PathMap[r.toLowerCase()];return!t.isNodeModulePath(i.filename)&&s?s:void 0},async compileFinished(){f()}},p(),n({modularName:"project",requireInNodeEnv:"cc.require",prefix:"preview-scripts"})],clear:!1,onlyRecordChanged:!0};await this.compiler.build(i)},getAssetDb:()=>Editor.isMainProcess?Editor.assetdb:Editor.remote.assetdb,async compileAndReload(){this.copyAllImportsToSrc(),await this.rebuild()},async rebuild(t){this.rebuildIndex(),t?await this.compiler.compileScripts(t.concat(m)):await this.compiler.rebuild()},rebuildIndex(){let s="\n";this.name2PathMap={},this.dst2ImportMap={};let o=i.sync(t.join(u,"/**/*.js"));(o=r.sortBy(o,this.import2raw.bind(this))).forEach(e=>{let i=this.import2raw(e),r=this.raw2Relative(i);s+=`require('./${c(t.stripExt(r))}');\n`;let o=c(this.raw2dest(i)),a=c(this.raw2src(i)),n=t.basenameNoExt(o).toLowerCase();this.name2PathMap[n]=a,this.dst2ImportMap[o]=e}),e.ensureFileSync(m),e.writeFileSync(m,s)},copyAllImportsToSrc(){i.sync(t.join(u,"/**/*.js")).forEach(t=>{let i=this.import2src(t);e.copySync(t,i),e.copySync(t+".map",i+".map")})},import2raw(e){let i=t.basenameNoExt(e);if(!this.isPlugin(i))return this.getAssetDb().uuidToFspath(i)},import2dest(t){let e=this.import2raw(t);return this.raw2dest(e)},import2src(t){let e=this.import2raw(t);return this.raw2src(e)},import2relative(t){let e=this.import2raw(t);return this.raw2Relative(e)},raw2import:t=>Editor.assetdb._fspathToImportPathNoExt(t)+".js",raw2dest(e){let i=this.raw2Relative(e),r=t.join(d,i);return r=t.stripExt(r)+".js"},raw2src(e){let i=this.raw2Relative(e),r=t.join(h,i);return r=t.stripExt(r)+".js"},dest2import(t){return this.dst2ImportMap[t]},raw2Relative(e){let i=this.getAssetDb().mountInfoByPath(e);if(!i)throw`Can not get mount info by path: ${e}`;return t.join(i.mountPath,t.relative(i.path,e))},isScript:t=>"javascript"===t||"coffeescript"===t||"typescript"===t,isPlugin(t){var e=this.getAssetDb()._uuid2meta[t]||this.getAssetDb().loadMetaByUuid(t);return e&&e.isPlugin},isNodeModulePath:t=>-1!==t.replace(/\\/g,"/").indexOf("/node_modules/"),needCompile(t,e){return"javascript"===t?!this.isPlugin(e):"coffeescript"===t||"typescript"===t}};module.exports=w;