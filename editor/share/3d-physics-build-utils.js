const e=require("browserify"),i=require("babelify"),s=require("vinyl-source-stream"),r=require("vinyl-buffer"),n=require("path"),u=require("gulp"),t=Editor.require("unpack://engine/gulp/util/utils"),l=require("./build-platforms"),o=Editor.require("unpack://engine/gulp/util/handleErrors.js"),p={"3D Physics/Builtin":"physics_builtin","3D Physics/cannon.js":"physics_cannon"},c={},d=[[require("@babel/preset-env"),{loose:!0}],require("@babel/preset-typescript")],a=[[require("@babel/plugin-proposal-decorators"),{legacy:!0}],[require("@babel/plugin-proposal-class-properties"),{loose:!0}],[require("babel-plugin-add-module-exports")]];c.getPhysicsModule=function(e,i){let s=Object.keys(p);return 0===(s=s.filter(i=>!e.includes(i))).length?null:s.length>1?(i&&i(),"3D Physics/cannon.js"):s[0]},c.getPhysicsEntries=function(e){let i=Editor.require("unpack://engine/modules.json"),s=Editor.url("unpack://engine"),r=null;if(i.some(i=>{return!(i.name!==e||!i.entries)&&(r=i.entries.map(e=>n.join(s,e)),!0)}),!r)throw new Error("Error on resolving physics modules");return r},c.getPhysicsBuildFlags=function(e){let i={};return Object.keys(p).forEach(e=>{i[p[e]]=!1}),e&&(i[p[e]]=!0),i},c.build=function({dest:p,excludedModules:c,debug:h,platform:g}){return new Promise((y,b)=>{let m=this.getPhysicsModule(c,()=>{Editor.warn(Editor.T("BUILDER.physics_module_undefined"))});if(!m)return y();Editor.log("Building 3D physics modules...");let q=this.getPhysicsEntries(m),f=this.getPhysicsBuildFlags(m),j=l[g].isNative,E="runtime"===g,P={jsb:j&&!E,runtime:E,minigame:"mini-game"===g,debug:h};f&&Object.assign(P,f);let k=new e({extensions:[".js",".ts"],entries:q}).transform(i,{extensions:[".js",".ts"],presets:d,plugins:a}).bundle().on("error",o.handler).pipe(o()).pipe(s(j?"physics.js":h?"physics.js":"physics-min.js")).pipe(r()).pipe(t.uglify("build",P)).pipe(u.dest(j?n.join(p,"src"):p));k.once("error",b),k.on("end",y)})},c.updateMinigameRequire=function({debug:e,excludedModules:i},s,r){if(this.getPhysicsModule(i)){let i=r||(e?"require('physics.js');":"require('physics-min.js');");s=s.replace("require('physics-js-path');",i)}else s=s.replace("require('physics-js-path');","");return s},module.exports=c;