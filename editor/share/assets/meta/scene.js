"use strict";var e=require("fire-fs"),r=require("fire-path"),t=require("./custom-asset"),i=require("semver");const a=["totalParticles","duration","emissionRate","life","lifeVar","angle","angleVar","startSize","startSizeVar","endSize","endSizeVar","startSpin","startSpinVar","endSpin","endSpinVar","sourcePos","posVar","gravity","speed","speedVar","tangentialAccel","tangentialAccelVar","radialAccel","radialAccelVar","rotationIsDir","startRadius","startRadiusVar","endRadius","endRadiusVar","rotatePerS","rotatePerSVar"],s=["premultipliedAlpha"];async function n(e,r){for(var t=JSON.stringify(e),i=0,a=r.length;i<a;++i)t=t.replace(new RegExp("_"+r[i],"g"),r[i]);return JSON.parse(t)}async function o(e,r){try{if(!Array.isArray(e))return e;const r=Editor.require("unpack://engine-dev/cocos2d/core/components/CCWidget");let t=cc.js._getClassId(r,!1);e=await async function(e,r,t,i){try{let a=await i();a=Editor.serialize(a,{stringify:!1});let s=[];for(let t=0;t<e.length;++t){let i=e[t];if(i.__type__===r){let e=i.node.__id__;s.includes(e)||s.push(e)}}for(let r=0;r<s.length;++r,a=JSON.parse(JSON.stringify(a))){let i=s[r],n=e[i];if(!n||!Array.isArray(n._components))continue;let o=!1;for(let r=0;r<n._components.length;++r){let i=n._components[r];if(!i)continue;let a=e[i.__id__];if(a&&a.__type__===t){o=!0;break}}o||(a.node={__id__:i},e.push(a),n._components.push({__id__:e.length-1}))}}catch(e){Editor.error(e)}return e}(e,"cc.Canvas",t,()=>{let e=new r;return"_alignFlags"in e||Editor.error("Internal: The '_alignFlags' property does not exist in cc.Widget"),e._alignFlags=45,e})}catch(e){Editor.error(e)}return e}class c extends t{constructor(e){super(e),this.asyncLoadAssets=!1,this.autoReleaseAssets=!1}static version(){return"1.2.6"}async import(t,i){e.readJson(t,async(e,a)=>{if(e)return i&&i(e),void 0;if(a){a=await c.verify(t,a),a=await c.migrate(t,a,this.uuid);var s=Editor.serialize.findRootObject(a,"cc.SceneAsset");s?s.asyncLoadAssets=this.asyncLoadAssets:Editor.warn(`Can not find scene assset in the scene file "${t}", it maybe corrupted!`);var n=Editor.serialize.findRootObject(a,"cc.Scene");n?(n.autoReleaseAssets=this.autoReleaseAssets,n._scale&&(n._scale.z=1)):Editor.warn(`Can not find scene in the scene file "${t}", it maybe corrupted!`),Editor.serialize.setName(a,r.basenameNoExt(t)),this._assetdb.saveAssetToLibrary(this.uuid,a)}i&&i(e)})}static defaultType(){return"scene"}static async verify(r,t){let i=!1;if(Array.isArray(t))for(var a=0;a<t.length;++a){var s=t[a];"cc.Node"!==s.__type__||void 0===s._components||Array.isArray(s._components)||(s._components=[],i=!0,Editor.warn(Editor.T("MESSAGE.scene.verify_compoents_warn",{name:s._name})))}return i&&e.writeFileSync(r,JSON.stringify(t,null,2)),t}static async migrate(r,t,_){let l=c.version();try{var d=e.readJsonSync(r+".meta");d&&(l=d.ver)}catch(e){return t}let y=!1;return i.satisfies(l,"< 1.0.1",{includePrerelease:!0})&&(t=await async function(e){if(Array.isArray(e))for(var r=0;r<e.length;r++){var t=e[r];"cc.ParticleSystem"===t.__type__?e[r]=await n(t,a):"sp.Skeleton"===t.__type__&&(e[r]=await n(t,s))}return e}(t),y=!0),i.satisfies(l,"< 1.0.2",{includePrerelease:!0})&&(t=await async function(e){if(Array.isArray(e))for(var r=0;r<e.length;r++){var t=e[r];"cc.LightComponent"===t.__type__&&(t.__type__="cc.Light")}return e}(t),y=!0),i.satisfies(l,"< 1.1.0",{includePrerelease:!0})&&(t=await async function(e,r){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];"cc.ParticleSystem"===i.__type__?0===i.positionType&&(i.positionType=1,Editor.warn(Editor.T("IMPORT_ASSET.parse_particle_positionType",{url:Editor.assetdb.uuidToUrl(r),nodeName:e[i.node.__id__]._name}))):"cc.Mask"===i.__type__&&0===i._N$alphaThreshold&&(i._N$alphaThreshold=.1)}return e}(t,_),y=!0),i.satisfies(l,"< 1.2.1",{includePrerelease:!0})&&(t=await async function(e,r){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];if("cc.Node"===i.__type__)if(void 0!==i._rotationX||void 0!==i._rotationY){if(0!==i._rotationX||0!==i._rotationY){let e=cc.v3();i._rotationX===i._rotationY?e.z=-i._rotationX:(e.x=i._rotationX,e.y=i._rotationY),i._eulerAngles=Editor.serialize(e,{stringify:!1})}i._rotationX=i._rotationY=void 0}else if(void 0!==i._quat){if(i._is3DNode)i._eulerAngles=Editor.serialize(cc.Quat.toEuler(cc.v3(),i._quat),{stringify:!1});else{const e=Math.PI/180;let r=cc.v3(0,0,Math.asin(i._quat.z)/e*2);i._eulerAngles=Editor.serialize(r,{stringify:!1})}i._quat=void 0}}return e}(t),y=!0),i.satisfies(l,"< 1.2.3",{includePrerelease:!0})?(t=await async function(e,r){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t],a=i.__type__;if("cc.Node"===a||"cc.Scene"===a){let e=new Float64Array(10);if(void 0!==i._trs){let r=i._trs.array;12===r.length&&(i._skewX=r[10],i._skewY=r[11]),e.set(r.slice(0,10))}else e[0]=0,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=0,e[6]=1,e[7]=1,e[8]=1,e[9]=1;void 0!==i._position&&(e[0]=i._position.x,e[1]=i._position.y,e[2]=i._position.z||0,i._position=void 0),void 0!==i._scaleX||void 0!==i._scaleY?(void 0!==i._scaleX&&(e[7]=i._scaleX,i._scaleX=void 0),void 0!==i._scaleY&&(e[8]=i._scaleY,i._scaleY=void 0),e[9]=1):void 0!==i._scale&&(e[7]=i._scale.x,e[8]=i._scale.y,e[9]=i._scale.z,i._scale=void 0),i._trs=Editor.serialize(e,{stringify:!1})}}return e}(t),y=!0):i.satisfies(l,"< 1.2.4",{includePrerelease:!0})&&(t=await async function(e,r){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t],a=i.__type__;if("cc.Node"===a||"cc.Scene"===a){let e=Float64Array.from(i._trs.array);i._trs=Editor.serialize(e,{stringify:!1})}}return e}(t),y=!0),i.satisfies(l,"< 1.2.5",{includePrerelease:!0})&&(t=await async function(e,r){if(Array.isArray(e))for(var t=0;t<e.length;t++){var i=e[t];if("cc.Camera"===i.__type__){if(!i.node)continue;var a=e[i.node.__id__];if(!a)continue;a._is3DNode&&(i._alignWithScreen=!1)}}return e}(t)),i.satisfies(l,"< 1.2.6",{includePrerelease:!0})&&(t=await o(t),y=!0),y&&e.writeFileSync(r,JSON.stringify(t,null,2)),t}}module.exports=c;