var{exec:t,execSync:n}=require("child_process"),i=require("path"),e=require("fire-fs"),o=require("fix-path"),r=require("net");function s(t){var n=new r.Socket,i=!1;n.connect("443","www.google-analytics.com",()=>{n.end(),!1===i&&(i=!0,t(!0))}),setTimeout(function(){n.end(),!1===i&&(i=!0,t(!1))},1e3)}let a={init:function(t,n,i){this.options=t,this.initEnvironmentPath(n,i)},initVivoProject:function(n){Editor.log(Editor.T("vivo-runtime.installing_npm_network")),t("mg init qgame --force",{env:this.environmentPath,cwd:i.join(this.options.dest,"..")},t=>{n(t)})},initEnvironmentPath:function(t,n){this.environmentPath={},t?(Editor.log(Editor.T("vivo-runtime.custom_npm_path_config"),t),"win32"===process.platform?this.environmentPath.Path=t:(this.environmentPath.PATH=t,this.environmentPath.PATH+=":/usr/bin:/bin:/usr/sbin:/sbin")):(n&&Editor.log(Editor.T("vivo-runtime.custom_npm_path_not_config")),o(),this.environmentPath=process.env)},isInitVivoProject:function(){return!(!e.existsSync(i.join(this.options.dest,"node_modules"))||e.existsSync(i.join(this.options.dest,"node_modules",".staging")))},isInstallVivoMinigameTool:function(){try{result=n("mg -v",{env:this.environmentPath})}catch(t){return!1}return!0},isCliProject:function(){return!!e.existsSync(i.join(this.options.dest,"minigame.config.js"))},getEnvirommentPath:function(){return this.environmentPath},isInstallNodeJs:function(t,i){try{n("node -v",{env:this.environmentPath})}catch(n){return i?(t.reply(new Error(Editor.T("vivo-runtime.custom_npm_path_config_error"))),void 0):(Editor.Ipc.sendToWins("builder:events","npmPath-show"),t.reply(),"win32"===process.platform?Editor.log(Editor.T("vivo-runtime.not_install_nodejs_windows_error")):Editor.log(Editor.T("vivo-runtime.not_install_nodejs_mac_error")),!1)}return!0},isInstallQGameAdapter:function(){return!!e.existsSync(this.getQGameAdapterPath())},installQGameAdapter:function(n){var i=this;s(function(e){if(!1===e)return n("no internet"),void 0;var o="win32"===process.platform?"npm.cmd":"npm";t(`${o} i -S @qgame/adapter@latest`,{env:i.environmentPath,cwd:i.options.dest},t=>{n(t)})})},isLatestVersion:function(n){let o=this;s(function(r){if(!1===r)return n(!1),void 0;if(!o.isInstallQGameAdapter())return n(!1),void 0;var s=i.join(o.options.dest,"node_modules","@qgame","adapter","package.json"),a=e.readJsonSync(s,{throws:!1});if(null===a)return n(!1),void 0;Editor.log("the current version @qgame/adapter is:",a.version);var d="win32"===process.platform?"npm.cmd":"npm";t(`${d} view @qgame/adapter@latest version`,{env:o.environmentPath,cwd:o.options.dest},(t,i)=>{if(t)return n&&n(o.isInstallQGameAdapter(),t),void 0;let e=i.toString().trim();if(Editor.log("the latest version of @qgame/adapter is:",e),a&&a.version===e)return n(!0),void 0;n(!1)})})},getQGameAdapterPath:function(){return i.join(this.options.dest,"node_modules","@qgame","adapter","dist","main.js")}};module.exports=a;