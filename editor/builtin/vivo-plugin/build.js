var e,i="minigame.config.js",n="game.js",t="manifest.json",r="qgame-adapter.js",o=require("path"),a=require("fs-extra");let s;var c,d,l,m,v,u,p,j,g="src",f="engine",y="sign",S="",E=require(Editor.url("packages://vivo-runtime/lib/cli"));function _(e){let i=Editor.url("packages://vivo-adapter");return void 0===e||""===e?i:o.join(i,e)}function b(e){var i=Editor.Project.path;void 0===i&&(i=Editor.projectPath);var n=o.join(i,"game.config.json"),t=s.package,r=s.name,c=s.versionName,l=s.versionCode,m=s.minPlatformVersion,v=s.deviceOrientation,u=s.logLevel,p={package:t,name:r,icon:`/image/${o.parse(d).base}`,versionName:c,versionCode:l,minPlatformVersion:m,deviceOrientation:v,type:"game",config:{logLevel:u},display:{}};let j=function(e){var i=e.buildResults._subpackages;if("{}"==JSON.stringify(i))return;var n=[];for(var t in i){var r=i[t].path,a=o.extname(r),s=o.basename(r,a),c={name:t,root:s+"/"};n.push(c)}return n}(e);void 0!==j&&(p.subpackages=j);var g=JSON.stringify(p);a.writeFileSync(n,g)}function k(i,n){if(E.init(n,s.npmPath,p),e=o.resolve(n.dest,"..","tempBuildDir"),function(i){h(o.join(e,".eslintrc.json"),o.join(i.dest,".eslintrc.json")),h(o.join(e,".npmignore"),o.join(i.dest,".npmignore")),h(o.join(e,"babel.config.js"),o.join(i.dest,"babel.config.js")),h(o.join(e,"minigame.config.js"),o.join(i.dest,"minigame.config.js")),h(o.join(e,"package.json"),o.join(i.dest,"package.json")),h(o.join(e,"package-lock.json"),o.join(i.dest,"package-lock.json"))}(n),c=n.dest,h(o.join(c,"main.js"),o.join(e,"main.js")),h(o.join(c,"src"),o.join(e,"src")),h(o.join(c,"res"),o.join(e,"res")),h(o.join(c,"subpackages"),o.join(e,"subpackages")),!1===E.isInstallNodeJs(i,s.npmPath))return;if(!1===E.isInstallVivoMinigameTool())return i.reply(new Error("please install tools: npm install -g @vivo-minigame/cli")),void 0;let t=E.isCliProject();if(!1===E.isInitVivoProject()||!1===t)return!1===t&&a.emptyDirSync(n.dest),E.initVivoProject(function(e){if(e)return Editor.log("init  game project failed"),void 0;a.emptyDirSync(o.join(n.dest,"src")),P(i,n)}),void 0;P(i,n)}function P(e,i){E.isLatestVersion(function(n,t){if(!0===n)return x(e,i),void 0;(function(e,i){Editor.log(Editor.T("vivo-runtime.download_qgame_adater")),E.installQGameAdapter(function(n){if(n)return Editor.log(Editor.T("vivo-runtime.download_qgame_adater_fail")),x(e,i),void 0;Editor.log(Editor.T("vivo-runtime.download_qgame_adater_success")),x(e,i)})})(e,i)})}function x(p,k){Editor.log("Checking config file ",k.dest);var P=E.getEnvirommentPath();Editor.log("Building game "+k.platform+" to "+c),b(k);var x=o.join(e,"res"),h=o.join(e,"src"),w=(_(),E.getQGameAdapterPath());a.existsSync(w)||(w=_(r)),a.writeFileSync(o.join(h,r),a.readFileSync(w)),function(){var e=o.join(c,g);a.emptyDirSync(e),a.writeFileSync(o.join(e,n),'require("main.js");');var i=Editor.Project.path;void 0===i&&(i=Editor.projectPath);var r=o.join(i,"game.config.json");a.writeFileSync(o.join(e,t),a.readFileSync(r));var s=o.join(e,"image");a.emptyDirSync(s),a.writeFileSync(o.join(s,o.parse(d).base),a.readFileSync(d))}(),function(){var e=o.join(c,y);if(a.emptyDirSync(e),!v){var i=o.join(e,"release");a.existsSync(i)||a.mkdirSync(i),a.existsSync(l)&&a.writeFileSync(o.join(i,"private.pem"),a.readFileSync(l)),a.existsSync(m)&&a.writeFileSync(o.join(i,"certificate.pem"),a.readFileSync(m))}var n=o.join(e,"debug");a.mkdirSync(n);var t=_("certificate.pem");a.writeFileSync(o.join(n,"certificate.pem"),a.readFileSync(t)),t=_("private.pem"),a.writeFileSync(o.join(n,"private.pem"),a.readFileSync(t))}(),function(i,n){var t=o.join(c,f);a.emptyDirSync(t),a.copySync(i,o.join(t,"src"));var r=o.join(e,"main.js"),s=a.readFileSync(r,"utf8"),d=(s=s.replace("window.jsb","window.qg")).indexOf("require('src/settings");s=(s=(s=s.slice(0,d)+"require('jsb-adapter/engine/rename-adapter.js');\n\t\trequire('src/qgame-adapter.js');\n\t\t"+s.slice(d)).replace("var isRuntime = (typeof loadRuntime === 'function');","")).replace("if (isRuntime)","if (true)"),a.writeFileSync(o.join(t,"main.js"),s)}(h),function(i){var n=i.buildResults._subpackages;if("{}"!=JSON.stringify(n))for(var t in n){let i=o.join(e,"subpackages",t),n=o.join(e,"subpackages",t,"index.js"),r=o.join(e,"subpackages",t,"game.js");a.existsSync(n)&&a.renameSync(n,r);let s=o.join(c,"src",t);a.copySync(i,s)}}(k);var T=require("child_process").exec,F="win32"===process.platform?"npm.cmd":"npm";function D(){Editor.log(Editor.T("vivo-runtime.rpk_installing")),T(`${F} run ${v?"build":"release"}`,{env:P,cwd:c},i=>{(function(){var i=o.join(e,"res"),n=o.join(c,"res");a.existsSync(i)&&!a.existsSync(n)&&(!0===s.tinyPackageMode&&a.copySync(i,n),a.existsSync(e)&&a.removeSync(e))})(),i?Editor.log(Editor.T("vivo-runtime.rpk_install_fail")+i):(Editor.log(Editor.T("vivo-runtime.rpk_install_success")),p.reply(),function(){var e=CocosEngine,i=parseInt("2.2.1".replace(/[^\d]/g,""));if(parseInt(e.slice(0,6).replace(/[^\d]/g,""))>=i==!0){var n;let e={resUrl:(n=void 0!==Editor.Profile.load.getSelfData?Editor.Profile.load("project://vivo-runtime.json").getSelfData():Editor.Profile.load("profile://project/vivo-runtime.json").data).tinyPackageServer,orientation:n.deviceOrientation,projectName:n.name};Editor.Ipc.sendToMain("builder:notify-build-result",j,e)}if(!0===s.useDebugKey||s.package.indexOf("test")>-1||s.name.indexOf("test")>-1||!0===u)return;Editor.Metrics.trackEvent("Project","BetaPlatforms","vivo-runtime",{packageName:s.package,appName:s.name,version:s.versionName,orientation:s.deviceOrientation})}())})}(async function(){let n=require("./build-jsb-adapter"),t=o.join(_(),"engine","index.js");!0===s.tinyPackageMode&&(t=o.join(_(),"engine","index_tiny_mode.js"));let r=o.join(c,"engine","jsb-adapter","engine","index.js");await n.build({rootPath:t,dstPath:r,isDebug:j.debug}),function(i,n){if(!1===s.tinyPackageMode)return a.copySync(x,o.join(i.dest,"src","res")),void 0;var t=s.tinyPackageServer;if(""===t)return p.reply(new Error("please enter remote server root")),void 0;let r=o.join(n,"engine","jsb-adapter","engine","index.js");var c=a.readFileSync(r,"utf8");c=c.replace("REMOTE_SERVER_ROOT_PLACE_HOLDER",t),a.writeFileSync(r,c),!0===s.packFirstScreenRes&&function(i){let n=i.buildResults;var t=n.getDependencies(i.startScene),r=o.join(e,"res","import");a.copySync(r,o.join(i.dest,"src","res","import")),a.removeSync(r);for(var s=0;s<t.length;++s){var c=t[s],d=n.getNativeAssetPath(c);if(!d||0===d.length)continue;let r=o.join(i.dest,"src",d.replace(i.dest,""));if(r.indexOf("\\subpackages")>-1){Editor.log(Editor.T("vivo-runtime.pack_res_to_first_pack_contain_subpack_res_error"));continue}let m=o.join(e,d.replace(i.dest,""));a.moveSync(m,r);var l=o.dirname(m);a.existsSync(l)&&0===a.readdirSync(l).length&&a.removeSync(l)}}(i)}(j,j.dest),function(){var e=o.join(c,"engine","jsb-adapter","engine");a.copySync(_(o.join("engine","rename-adapter.js")),o.join(e,"rename-adapter.js")),S="",function e(i,n){a.readdirSync(i).forEach(function(t){var r=o.join(i,t),s=a.statSync(r);if(s&&s.isDirectory())e(r,n);else if(".js"===o.extname(r)){var c=r.slice(n.length+1,r.length);if("main.js"!==c&&(0!==c.indexOf("jsb-adapter")||"index.js"===t||"rename-adapter.js"===t)){c=c.replace(/\\/g,"/");var d={};d.module_name=c.replace("engine/",""),d.module_path=c.replace("engine/",""),d.module_from=c,S+=JSON.stringify(d)+",\n"}}})}(o.join(c,"engine"),o.join(c)),function(){var e=_(i),n=a.readFileSync(e,"utf8");n=n.replace("EXTERNALS_PLACEHOLDER",S),a.writeFileSync(o.join(c,i),n)}(),a.existsSync(o.join(c,"node_modules"))&&!a.existsSync(o.join(c,"node_modules",".staging"))?D():(Editor.log(Editor.T("vivo-runtime.installing_npm_network")),T(`${F} install`,{env:P,cwd:c},e=>{e?p.reply(new Error(Editor.T("vivo-runtime.npm_install_fail"))):(Editor.log(Editor.T("vivo-runtime.npm_installed_success")),D())}))}()})()}function h(e,i){a.existsSync(e)&&(a.copySync(e,i),a.removeSync(e))}module.exports={name:Editor.T("vivo-runtime.platform_name"),platform:"qgame",extends:"runtime",buttons:[Editor.Builder.DefaultButtons.Build,{label:Editor.T("BUILDER.play"),message:"play"}],messages:{"build-start":function(i,n){e=o.resolve(n.dest,"..","tempBuildDir"),function(i){h(o.join(i.dest,".eslintrc.json"),o.join(e,".eslintrc.json")),h(o.join(i.dest,".npmignore"),o.join(e,".npmignore")),h(o.join(i.dest,"babel.config.js"),o.join(e,"babel.config.js")),h(o.join(i.dest,"minigame.config.js"),o.join(e,"minigame.config.js")),h(o.join(i.dest,"package.json"),o.join(e,"package.json")),h(o.join(i.dest,"package-lock.json"),o.join(e,"package-lock.json"))}(n),i.reply()},"build-finished":function(e,i){var n;j=i,void 0!==Editor.Profile.load.getSelfData?(n=Editor.Profile.load("project://vivo-runtime.json"),s=n.getSelfData()):(n=Editor.Profile.load("profile://project/vivo-runtime.json"),s=n.data);var t=(s=n.data).package,r=s.name,o=s.icon,c=s.versionName,g=s.versionCode,f=s.minPlatformVersion;p=s.showNpmPath,u=i.debug,sendStatisticsSourceMaps=i.sourceMaps,d=o||"",d=o.trim(),l=s.privatePath||"",m=s.certificatePath||"",v=s.useDebugKey;var y=!0,S=[],E="";if([{name:Editor.T("vivo-runtime.package"),value:t},{name:Editor.T("vivo-runtime.name"),value:r},{name:Editor.T("vivo-runtime.desktop_icon"),value:o},{name:Editor.T("vivo-runtime.version_name"),value:c},{name:Editor.T("vivo-runtime.version_number"),value:g},{name:Editor.T("vivo-runtime.support_min_platform"),value:f}].forEach(function(e){e.value||(y=!1,S.push(e.name))}),y||(E+=S.join("ã€")+Editor.T("vivo-runtime.not_empty")),o&&(a.existsSync(d)||(y=!1,E+=o+Editor.T("vivo-runtime.icon_not_exist"))),v||(""===l?(y=!1,E+=Editor.T("vivo-runtime.select_private_pem_path")):a.existsSync(l)||(y=!1,E+=`${l} `+Editor.T("vivo-runtime.signature_not_exist")),""===m?(y=!1,E+=Editor.T("vivo-runtime.select_certificate_pem_path")):a.existsSync(m)||(y=!1,E+=`${m}`+Editor.T("vivo-runtime.signature_not_exist"))),!y)return e.reply(new Error(E)),void 0;k(e,i)},play:(e,i)=>{Editor.Panel.open("vivo-runtime.qrcode",i)}},settings:Editor.url("packages://vivo-runtime/build-ui.js")};