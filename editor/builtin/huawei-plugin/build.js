var e,i="manifest.json",r=require("path"),n=require("fs-extra"),t=require("fix-path");let a;var o,s,u,c,d,p,l,m,f,v,g,h,y="game.js",_={},E=!1;function j(e){let i=Editor.url("packages://huawei-adapter");return void 0===e||""===e?i:r.join(i,e)}function w(t,o){n.emptyDirSync(o);var c=r.join(t.dest,"res"),p=r.join(t.dest,"src"),l=r.join(t.dest,"jsb-adapter"),m=r.join(t.dest,"subpackages"),v=r.join(o,"jsb-adapter"),g=r.join(o,"res"),h=r.join(o,"src"),_=r.join(o,"subpackages");n.copySync(l,v),a.tinyPackageMode||n.copySync(c,g),n.copySync(p,h),n.existsSync(m)&&n.copySync(m,_),function(e){var i=r.join(e,"image");n.ensureDirSync(i),n.writeFileSync(r.join(i,r.parse(u).base),n.readFileSync(u))}(o),function(i){var t=r.join(e,"main.js"),a=n.readFileSync(t,"utf8");n.writeFileSync(r.join(i,y),a)}(o),function(e,i){if(!1===a.tinyPackageMode)return;var t=a.tinyPackageServer;if(""===t)return event.reply(new Error("please enter remote server root")),void 0;let o=r.join(i,"engine","index.js");var u=n.readFileSync(o,"utf8");u=u.replace("REMOTE_SERVER_ROOT_PLACE_HOLDER",t),n.writeFileSync(o,u),!0===a.packFirstScreenRes&&function(e){let i=e.buildResults;var t=i.getDependencies(e.startScene),a=r.join(e.dest,"res","import");n.copySync(a,r.join(s,"res","import")),n.removeSync(a);for(var o=0;o<t.length;++o){var u=t[o],c=i.getNativeAssetPath(u);if(!c||0===c.length)continue;let a=r.join(s,c.replace(e.dest,""));if(a.indexOf("\\subpackages")>-1){Editor.log(Editor.T("huawei-runtime.pack_res_to_first_pack_contain_subpack_res_error"));continue}let p=r.join(e.dest,c.replace(e.dest,""));n.moveSync(p,a);var d=r.dirname(p);n.existsSync(d)&&0===n.readdirSync(d).length&&n.removeSync(d)}}(e)}(t,v),function(e){var t=r.join(e,i),o=a.package,s=a.name,c=a.versionName,p=a.versionCode,l=a.minPlatformVersion,m=a.deviceOrientation,v=a.logLevel,g={package:o,appType:"fastgame",name:s,versionName:c,versionCode:p,icon:`/image/${r.parse(u).base}`,minPlatformVersion:l,permissions:[{origin:"*"}],router:{}};if(d&&(g.subpackages=d),n.existsSync(f)){var h;try{h=n.readJsonSync(f),Editor.log(Editor.T("huawei-runtime.custom_manifest_data"),JSON.stringify(h))}catch(e){Editor.log(Editor.T("huawei-runtime.custom_manifest_data_error"))}if(h)for(var y in h)"package"!==y&&"appType"!==y&&"name"!==y&&"versionName"!==y&&"versionCode"!==y&&"icon"!==y&&"minPlatformVersion"!==y&&"permissions"!==y&&(g[y]=h[y])}var _={},E={};g.config&&(_=g.config),g.display&&(E=g.display),_.logLevel=v,E.orientation=m,E.fullScreen=a.fullScreen,g.display=E;var j=JSON.stringify(g);n.writeFileSync(t,j)}(o)}function S(i,u){Editor.log("Checking config file "+u.dest),o=u.dest,s=r.join(o,"build"),c=Editor.url("packages://huawei-adapter/package"),e=u.dest,n.emptyDirSync(s);var p=r.join(o,"build");(function(e){var i=e.buildResults._subpackages;if("{}"==JSON.stringify(i))d=void 0;else{var n=[],t=[];for(var a in i){var o=i[a].name,s=i[a].path,u=r.join(r.dirname(s),o);u=u.replace(/\\/g,"/");var c={name:o,resource:u},p={name:o,original:s,newPath:u};n.push(c),t.push(p)}d=n,backUpGroup=t}})(u),n.emptyDirSync(r.join(o,"dist")),async function(){let e=require("./build-jsb-adapter"),l=r.join(j(),"engine","index.js");!0===a.tinyPackageMode&&(l=r.join(j(),"engine","index_tiny_mode.js"));let m=r.join(o,"jsb-adapter","engine","index.js");await e.build({rootPath:l,dstPath:m,isDebug:h.debug}),w(u,p),function(){var e=r.join(s,"subpackages");if(n.existsSync(e))for(var i in d){var t=r.join(s,d[i].resource,"index.js"),a=r.join(s,d[i].resource,"game.js");n.existsSync(t)&&n.renameSync(t,a)}}(),function(){var e=require("child_process").exec,s="win32"===process.platform?"npm.cmd":"npm";_={},a.npmPath?(E=!1,Editor.log(Editor.T("huawei-runtime.custom_npm_path_config"),a.npmPath),"win32"===process.platform?_.Path=a.npmPath:_.PATH=a.npmPath):(g&&Editor.log(Editor.T("huawei-runtime.custom_npm_path_not_config")),E||(E=!0,t()),_=process.env);(function(r){e(`${s} -v`,{env:_,cwd:o},e=>{if(e){if(a.npmPath)return i.reply(new Error(Editor.T("huawei-runtime.custom_npm_path_config_error"))),void 0;if(Editor.Ipc.sendToWins("builder:events","npmPath-show"),"win32"===process.platform)return i.reply(new Error(Editor.T("huawei-runtime.window_default_npm_path_error"))),void 0;i.reply(new Error(Editor.T("huawei-runtime.mac_default_npm_path_error")))}else r&&r()})})(function(){if(n.existsSync(r.join(c,"node_modules")))k(i,e);else{Editor.log(Editor.T("huawei-runtime.begin_install_npm")),void e(`${s} install`,{env:process.env,cwd:c},r=>{if(!r)return Editor.log(Editor.T("huawei-runtime.npm_installed_success")),k(i,e),void 0;i.reply(new Error(Editor.T("huawei-runtime.npm_installed_success")+r))})}})}()}()}function k(i,t){var s=r.join(o,"dist"),u=r.join(o,"build"),c=m?j("private.pem"):p,d=m?j("certificate.pem"):l,f=a.package,g=`node ${r.join(Editor.url("packages://huawei-adapter/package"),"index.js")} ${u} ${s} ${f} ${c} ${d}`;Editor.log(Editor.T("huawei-runtime.rpk_installing")),t(`${g}`,{env:_,cwd:o},t=>{if(t)return i.reply(new Error(Editor.T("huawei-runtime.rpk_install_fail")+t)),void 0;Editor.log(Editor.T("huawei-runtime.rpk_install_success")),function(){if(!s)return;var i=r.join(e,"res"),t=r.join(o,"res"),s=a.tinyPackageMode;n.copySync(i,t)}(),function(){var e=CocosEngine,i=parseInt("2.2.1".replace(/[^\d]/g,""));if(parseInt(e.slice(0,6).replace(/[^\d]/g,""))>=i==!0){var r;let e={resUrl:(r=void 0!==Editor.Profile.load.getSelfData?Editor.Profile.load("project://huawei-runtime.json").getSelfData():Editor.Profile.load("profile://project/huawei-runtime.json").data).tinyPackageServer,orientation:r.deviceOrientation,projectName:r.name};Editor.Ipc.sendToMain("builder:notify-build-result",h,e)}if(!0===a.useDebugKey||a.package.indexOf("test")>-1||a.name.indexOf("test")>-1||1==v)return;Editor.Metrics.trackEvent("Project","BetaPlatforms","huawei-runtime",{packageName:a.package,appName:a.name,version:a.versionName,orientation:a.deviceOrientation})}(),i.reply()})}module.exports={name:Editor.T("huawei-runtime.platform_name"),platform:"huawei",extends:"runtime",buttons:[Editor.Builder.DefaultButtons.Build,{label:Editor.T("BUILDER.play"),message:"play"}],messages:{"build-finished":function(e,i){var r;h=i,void 0!==Editor.Profile.load.getSelfData?(r=Editor.Profile.load("project://huawei-runtime.json"),a=r.getSelfData()):(r=Editor.Profile.load("profile://project/huawei-runtime.json"),a=r.data);var t=a.package,o=a.name,s=a.icon,c=a.versionName,d=a.versionCode,y=a.minPlatformVersion;g=a.showNpmPath,p=a.privatePath,l=a.certificatePath,m=a.useDebugKey,u=s||"",f=a.manifestPath,v=i.debug,sendStatisticsSourceMaps=i.sourceMaps,f||Editor.log(Editor.T("huawei-runtime.not_mainfest_data"));var _=!0,E=[],j="";if([{name:Editor.T("huawei-runtime.package"),value:t},{name:Editor.T("huawei-runtime.name"),value:o},{name:Editor.T("huawei-runtime.desktop_icon"),value:s},{name:Editor.T("huawei-runtime.version_name"),value:c},{name:Editor.T("huawei-runtime.version_number"),value:d},{name:Editor.T("huawei-runtime.support_min_platform"),value:y}].forEach(function(e){e.value||(_=!1,E.push(e.name))}),_||(j+=E.join("ã€")+Editor.T("huawei-runtime.not_empty")),s&&(n.existsSync(u)||(_=!1,j+=s+Editor.T("huawei-runtime.icon_not_exist"))),m||(""===p?(_=!1,j+=Editor.T("huawei-runtime.private_pem_path_error")):n.existsSync(p)||(_=!1,j+=`${p}`+Editor.T("huawei-runtime.signature_not_exist")),""===l?(_=!1,j+=Editor.T("huawei-runtime.certificate_pem_path_error")):n.existsSync(l)||(_=!1,j+=`${l} `+Editor.T("huawei-runtime.signature_not_exist"))),!_)return e.reply(new Error(j)),void 0;S(e,i)},play:(e,i)=>{Editor.Panel.open("runtime-dev-tools",i)}},settings:Editor.url("packages://huawei-runtime/build-ui.js")};