"use strict";const e=require("fs"),t=require("path"),s=require("../utils/cache"),i=require("../utils/operation");exports.template=e.readFileSync(t.join(__dirname,"../template/search.html"),"utf-8"),exports.components={node:require("./node")},exports.props=["filter"],exports.data=function(){return{nodes:[],type:null,text:"",uuids:null}};let r=[];exports.watch={filter(){let e=this.filter;if(/^t:.*/.test(e)){let t=e.match(/t\:([^ ]+) ?([^ ]+)?/);this.type=t?t[1]:null,this.text=t?t[2]:"",this.type&&"cc.Node"!==this.type?(Editor.Ipc.cancelRequest(this._queryID),this._queryID=Editor.Ipc.sendToPanel("scene","scene:query-nodes-by-comp-name",this.type,(e,t)=>{this.uuids=t},-1)):this.uuids=null}else if(/^used:.*/.test(e)){let t=e.match(/used\:([^ ]+) ?([^ ]+)?/),s=t?t[1]:"";Editor.Ipc.cancelRequest(this._queryID),this._queryID=Editor.Ipc.sendToPanel("scene","scene:query-nodes-by-usedby-uuid",s,(e,t)=>{this.uuids=t},-1)}else this.text=e;if(this.nodes=[],!this.filter)return this.nodes.forEach(e=>{let t=r[e.id];t&&(e.showIndex=t)}),void 0;let t=0,i=s.queryNodes();for(let e=0;e<i.length;++e){let s=i[e],o=s.name.toLowerCase();s.isSearch=-1!==o.indexOf(this.filter.toLowerCase()),s.isSearch&&(r[s.id]=s.showIndex,s.showIndex=t++,this.nodes.push(s))}}},exports.methods={onDragStart(e){e.stopPropagation();let t=Editor.Selection.contexts("node");if(!t||t.length<=0)return e.preventDefault(),void 0;i.staging(t);let s=this.nodes.filter(e=>e.selected);Editor.UI.DragDrop.start(e.dataTransfer,{buildImage:!0,effect:"copyMove",type:"node",items:s.map(e=>({id:e.id,name:e.name}))})},onDragEnd(e){e.stopPropagation(),i.restore(),Editor.UI.DragDrop.end()}};