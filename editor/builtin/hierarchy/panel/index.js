"use strict";const e=require("fire-fs"),t=(require("fire-path"),Editor.require("scene://utils/animation")),r=Editor.require("packages://hierarchy/panel/utils/event"),n=Editor.require("packages://hierarchy/panel/utils/cache"),o=Editor.require("packages://hierarchy/panel/utils/operation"),i=Editor.require("packages://hierarchy/panel/manager"),s=Editor.require("packages://hierarchy/panel/utils/communication");function l(e){let t=Editor.Selection.curSelection("node");Editor.Ipc.sendToWins("scene:center-nodes",t),a(t,e)}function a(e,t){let r=e[e.length-1];if(!r)return;let i=n.queryNode(r);i&&(i.isSearch||o.foldAllParentNodeState(i,!1),requestAnimationFrame(()=>{let e=20*i.showIndex,r=t.clientHeight,n=t.scrollTop;e>n+r-20?t.scrollTop=e-r+20:e<n&&(t.scrollTop=e)}))}Editor.Panel.extend({listeners:{"panel-resize"(){this._vm.length=(this.clientHeight-56)/20+3}},style:e.readFileSync(Editor.url("packages://hierarchy/panel/style/index.css")),template:e.readFileSync(Editor.url("packages://hierarchy/panel/template/index.html")),messages:{"scene:ready"(){i.startup()},"scene:reloading"(){i.stop()},"selection:selected"(e,t,r){"node"===t&&(r.forEach(e=>{o.select(e,!0)}),a(r,this._vm.$els.nodes))},"selection:unselected"(e,t,r){"node"===t&&r.forEach(e=>{o.select(e,!1)})},"scene:animation-record-changed"(e,t,r){s.setRecord(!!t),o.ignore(r,t)},"change-filter"(e,t){this._vm.filter=t},delete(e,t){Editor.Selection.unselect("node",t,!0),Editor.Ipc.sendToPanel("scene","scene:delete-nodes",t)},rename(e,t){o.rename(t)},"show-path"(e,t){o.print(t)},duplicate(e,t){Editor.Ipc.sendToPanel("scene","scene:duplicate-nodes",t)},filter(e,t){this._vm.filter=t},hint(e,t){o.hint(t)},"hierarchy:hint"(e,t){this._vm.$refs.nodes.scrollToItem(t)}},ready(){this._vm=function(e,t){return new Vue({el:e,data:{length:0,filter:""},watch:{},methods:{},components:{tools:Editor.require("packages://hierarchy/panel/component/tools"),nodes:Editor.require("packages://hierarchy/panel/component/nodes"),search:Editor.require("packages://hierarchy/panel/component/search")},created(){Editor.Ipc.sendToPanel("scene","scene:is-ready",(e,t)=>{t&&i.startup()},-1),r.on("filter-changed",e=>{this.filter=e,""===e&&l(this.$els.nodes)}),r.on("empty-filter",()=>{l(this.$els.nodes)})}})}(this.shadowRoot),this._vm.length=(this.clientHeight-56)/20+3,n.initNodeState(),n.initNodeStateProfile()},close(){n.saveNodeTreeStateProfile()},selectAll(e){e&&(e.stopPropagation(),e.preventDefault());let t=[];n.queryNodes().forEach(e=>{t.push(e.id),e.children.length>0&&o.fold(e.id,!1)}),Editor.Selection.select("node",t,!0,!1)},delete(e){if(e&&(e.stopPropagation(),e.preventDefault()),t.STATE.RECORD)return;let r=[];n.queryNodes().forEach(e=>{e.selected&&r.push(e.id)}),Editor.Selection.unselect("node",r,!0),Editor.Ipc.sendToPanel("scene","scene:delete-nodes",r)},up(e){e&&(e.stopPropagation(),e.preventDefault());let t=n.queryNodes();for(let e=0;e<t.length;e++){let r=t[e],n=r.showIndex;if(r&&r.selected){for(e;e>=0;e--){let r=t[e];if((!this._vm.filter||r.isSearch)&&(r.showIndex>=0&&r.showIndex<n)){Editor.Selection.select("node",r.id,!0,!0);break}}break}}},down(e){e&&(e.stopPropagation(),e.preventDefault());let t=n.queryNodes();for(let e=t.length-1;e>=0;e--){let r=t[e],n=r.showIndex;if(r&&r.selected){for(e;e<t.length;e++){let r=t[e];if((!this._vm.filter||r.isSearch)&&r.showIndex>n){Editor.Selection.select("node",r.id,!0,!0);break}}break}}},left(e){e&&(e.stopPropagation(),e.preventDefault()),n.queryNodes().forEach(e=>{e.selected&&o.fold(e.id,!0)})},right(e){e&&(e.stopPropagation(),e.preventDefault()),n.queryNodes().forEach(e=>{e.selected&&o.fold(e.id,!1)})},shiftUp(){},shiftDown(){},f2(e){if(e&&(e.stopPropagation(),e.preventDefault()),t.STATE.RECORD)return;let r=n.queryNodes();for(let e=0;e<r.length;e++){let t=r[e];if(t&&t.selected){o.rename(t.id,!0);break}}},find(e){let t=Editor.Selection.curSelection("node");t.some(e=>{let t=n.queryNode(e);return t&&t.rename})||(e&&(e.stopPropagation(),e.preventDefault()),Editor.Ipc.sendToWins("scene:center-nodes",t))},copy(){if(t.STATE.RECORD)return;let e=Editor.Selection.curSelection("node");Editor.Ipc.sendToPanel("scene","scene:copy-nodes",e)},paste(){if(t.STATE.RECORD)return;let e=Editor.Selection.curActivate("node"),r=n.queryNode(e);r&&r.parent&&(e=r.parent),Editor.Ipc.sendToPanel("scene","scene:paste-nodes",e)},duplicate(){if(t.STATE.RECORD)return;let e=Editor.Selection.curSelection("node");e.length>0&&Editor.Ipc.sendToPanel("hierarchy","duplicate",e)}});