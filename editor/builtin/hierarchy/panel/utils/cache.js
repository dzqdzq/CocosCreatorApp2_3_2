"use strict";require("fire-fs"),require("fire-path");const e=require("./event"),t={EXPAND_ALL:1,COLLAPSE_ALL:2,MEMORY_LAST_STATE:3};let n=!1,o={},l=[],r=[],i=[],d=t.COLLAPSE_ALL;exports.lineHeight=20,exports.foldState=void 0,exports.queryCache=function(){return o},exports.queryRoots=function(){return l},exports.queryNodes=function(){return r},exports.queryNode=function(e){let t=o[e];return t||null},exports.getRootNodeByTargetNode=function(e){let t=e.parent;if(t){let e=this.queryNode(t);return this.getRootNodeByTargetNode(e)}return e};let s=function(e){let n=Editor.Selection.curSelection("node");return{id:e.id,name:e.name,prefabState:e.prefabState,locked:e.locked,isActive:e.isActive,parent:null,children:[],next:null,prev:null,index:0,showIndex:0,selected:-1!==n.indexOf(e.id),fold:function(e){if(void 0!==e.fold)return e.fold;return d===t.MEMORY_LAST_STATE?-1===i.indexOf(e.id):void 0!==exports.foldState?exports.foldState:e.fold}(e),show:!0,rename:!1,level:0,ignore:!1,hint:!1,isSearch:!1}};exports.add=function(t,n,i){if(n&&!o[n])return console.warn(`Hierarchy - 插入缓存失败，父节点不存在 ${n}`),!1;if(t=s(t),o[t.id]=t,!n){let e=l.indexOf(t.id);-1!==e&&i!==e&&(l.splice(e,1),e=-1),-1===e&&l.splice(i,0,t.id)}if(n){i=i||0,t.parent=n;let e=o[n],l=e.children.indexOf(t.id);-1!==l&&i!==l&&(e.children.splice(l,1),l=-1),-1===l&&e.children.splice(i,0,t.id),t.level=e.level+1,t.prev=e.children[i-1]||null,t.next=e.children[i+1]||null}else t.level=0,t.prev=l[i-1]||null,t.next=l[i+1]||null;t.prev&&(o[t.prev].next=t.id),t.next&&(o[t.next].prev=t.id);let d=0,f=0,c=t;for(;c&&!c.next;)c=o[c.parent];if(c){let e=o[c.next];r.splice(e.index,0,t),d=e.index,f=e.showIndex}else{for(let e=(d=r.length)-1;e>=0;e--){let t=r[e];if(t.show){f=t.showIndex+1;break}}r.push(t)}for(let e=d;e<r.length;e++){let t=r[e];t.index=e,t.show?t.showIndex=f++:t.showIndex=-1}0,e.emit("node-added",t)},exports.remove=function(t){let i=o[t];if(!i)return console.warn(`Hierarchy - 删除缓存失败，节点不存在 ${t}`),[];let d=[{id:t,oldNode:i}];if(i.parent){let e=o[i.parent],n=e.children.indexOf(t);-1!==n&&e.children.splice(n,1)}let s=o[i.prev],f=o[i.next];for(s&&(s.next=f?f.id:null),f&&(f.prev=s?s.id:null),n=!0;i.children.length>0;){exports.remove(i.children[0]).forEach(e=>{d.push({id:e.id,oldNode:e.oldNode})})}if(n=!1,delete o[t],!i.parent){let e=l.indexOf(t);-1!==e&&l.splice(e,1)}let c=i.index;if(r.splice(i.index,1),r.length>0){let e;if(c<=0)e=0;else for(let t=c-1;t>=0;t--){let n=r[t];if(n.show){e=n.showIndex+1;break}}for(let t=c;t<r.length;t++){let n=r[t];n.index=t,n.show?n.showIndex=e++:n.showIndex=-1}}return 0,e.emit("node-removed",i),d},exports.clear=function(){for(;r.length>0;)r.pop();for(;l.length>0;)l.pop();Object.keys(o).forEach(e=>{delete o[e]})};const f=Editor.Profile.load("global://settings.json");exports.initNodeState=function(){(d=f.get("node-tree-state"))===t.MEMORY_LAST_STATE?this.foldState=void 0:this.foldState=d===t.COLLAPSE_ALL};const c=Editor.Profile.load("local://node-tree-state.json");exports.initNodeStateProfile=function(){(i=c.get("nodeFoldStates"))||(i=[],c.set("nodeFoldStates",i),c.save())},exports.saveNodeTreeStateProfile=function(){0,c&&(c.set("nodeFoldStates",i),c.save())},exports.saveNodeFoldState=function(e,t){let n=i.indexOf(e);if(-1!==n&&t)return 0,i.splice(n,1),void 0;if(!t&&-1===n){0,i.push(e);let t=i.length-500;t>0&&i.shift(0,t)}};