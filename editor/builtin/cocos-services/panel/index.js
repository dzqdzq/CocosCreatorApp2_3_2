let e=Editor.require("packages://cocos-services/panel/bindGame/bindGame.js"),i=Editor.require("packages://cocos-services/panel/serviceList/serviceList.js"),s=Editor.require("packages://cocos-services/panel/serviceDetail/serviceDetail.js"),t=Editor.require("packages://cocos-services/panel/utils/ccServices.js"),a=Editor.require("packages://cocos-services/panel/utils/utils.js"),c=Editor.require("packages://cocos-services/panel/utils/serviceConfig.js"),o=Editor.require("packages://cocos-services/panel/toast/toast.js"),r=require("fs");require("path");Editor.require("packages://cocos-services/panel/utils/ccServicesAnalytics.js"),window.fs=r,window.ccServices=t;const n=a.getProjectID();let d=async()=>{await t.init()};Editor.Panel.extend({style:r.readFileSync(Editor.url("packages://cocos-services/panel/assets/style.css","utf8")),template:`\n  <body class='body'>\n    <div id="loader-wrapper">\n      <div id="loader"></div>\n      <div class="loader-section section-left"></div>\n      <div class="loader-section section-right"></div>\n      <br>\n      <div class="load_title">\n        <br>\n        ${a.t("load_cocos_services")}\n        <br>\n        <span> V${t.getDisplayVersion()}</span>\n      </div>\n    </div>\n    <div style="overflow-x: hidden; overflow-y: auto; height:100%;">\n      <toast v-show="visible" :message="message" :visible="visible" :status="status"></toast>\n      <bind-game v-if="isShowBindGame" :islogin="isLogin" @back-home="backHome" @bind-game="bindGameLogic"></bind-game>\n      <service-list v-if="isShowHome" :isCompanyGame="isCompanyGame" :game="game" :services="services" @service-item-click="serviceItemClick" @bind-game="bindGame" @unbind-game="unbindGame"></service-list>\n      <service-detail v-if="isShowService" @back-home="backHome" @enable-service="enableService" :service="service"></service-detail>\n      <ui-loader class="massive" v-if="isDownloadServicePackage"><div style="margin-top:10px; font-size: 14px;">{{ downloadTip }}</div></ui-loader>\n    </div>\n  </body>\n  `,$:{loader_wrapper:"#loader-wrapper",loader_service:"ui-loader"},async ready(){this.$loader_service.hidden=!0;var l=this.$loader_wrapper,v=this.$loader_service;if(await t.init(),e.init(),i.init(),s.init(),o.init(),Editor.User.on("login",d),Editor.User.on("logout",d),window.CocosServicesUpdate=!1,0!==this.clientHeight){var h=c.readBindGame();h||(h={app_id:"UNKNOW"}),window.ccServicesAnalytics&&window.ccServicesAnalytics.init(t.getUserData().cocos_uid,h,{}),window.ccServicesAnalytics&&window.ccServicesAnalytics.openServicePanel()}window.CocosServices=new window.Vue({el:this.shadowRoot,data:{message:"123",visible:!1,status:2,isLogin:!1,isBindGame:!1,isShowBindGame:!1,isShowHome:!0,isShowService:!1,isCompanyUser:!1,isCompanyGame:!1,isItemClickToBindGame:!1,isUpdate:!1,isDownloadServicePackage:!1,downloadTip:a.t("installing"),service:{},game:{name:a.t("unknow_game"),appid:"UNKNOW"},user:{},services:[]},watch:{async game(e,i){var s=c.readEnableService();for(var a of this.services)s.indexOf(a.service_id)>=0?a.enable=!0:a.enable=!1;t.getUserIsLogin()&&await t.getGameDetail(this.game.appid)}},created(){l.hidden=!0,v.hidden=!1;var e=c.readBindGame();e&&"UNKNOW"!=e.appid&&this.checkGameOwner(e)?(this.game=e,this.isBindGame=!0,this.isCompanyGame="0"!==e.cid):(this.game={name:a.t("unknow_game"),appid:"UNKNOW"},this.isBindGame=!1,this.isCompanyGame=!1,c.writeBindGame(this.game)),this.services=c.readServiceList(),this.user=t.getUserData(),this.isCompanyUser=0!==this.user.corporation_id,this.isLogin=t.getUserIsLogin(),this.readEnableService();var i=a.getCreatorHomePath()+"/services";!r.existsSync(i)&&a.mkdirs(i),this.watchFiles(i,(e,i,s)=>{console.log("isRemove",e),console.log("CocosServicesUpdate",window.CocosServicesUpdate),e&&!window.CocosServicesUpdate&&(this.enableService(i,!1),a.printToCreatorConsole("warn",s+" - "+a.t("service_delete_accident")),this.isShowHome=!1,this.isShowService=!1,this.isShowBindGame=!0,this.$nextTick(()=>{this.isShowHome=!0,this.isShowService=!1,this.isShowBindGame=!1})),window.CocosServicesUpdate=!1})},methods:{showTips:function(e,i,s=1500){this.visible=!0,this.status=e,this.message=i,-1!==s&&setTimeout(()=>{this.visible=!1},s)},utils_t:function(e,...i){return a.t(e,...i)},backHome:function(){this.isShowHome=!0,this.isShowService=!1,this.isShowBindGame=!1},serviceItemClick:function(e){if("UNKNOW"!=this.game.appid)if(this.isCompanyUser){if(this.isCompanyGame){if("1"===e.service_type)return}else if("2"===e.service_type)return}else if("2"===e.service_type)return;this.isShowHome=!1,window.ccServicesAnalytics&&window.ccServicesAnalytics.init(this.user.cocos_uid,this.game,e),"0"===e.service_type||this.isBindGame?(this.isShowService=!0,this.isShowBindGame=!1,window.ccServicesAnalytics&&window.ccServicesAnalytics.enterService()):(this.isShowService=!1,this.isShowBindGame=!0,this.isItemClickToBindGame=!0,window.ccServicesAnalytics&&window.ccServicesAnalytics.enterBindCocosAppID());var i=e.service_dev_url;i.match(/app_id/)&&(i=i.replace("<app_id>",this.game.appid)),e.service_dev_url=i,this.service=e},checkGameOwner:function(e){var i=t.getGameLists();if(!i)return!1;for(var s of i.data)if(s.app_id===e.appid)return!0;return a.printToCreatorConsole("warn",this.utils_t("not_owner")),!1},bindGameLogic:async function(e){if(this.game=e,""!==n){var i=await t.associateProjectID(this.game.appid,n,1);if(0!==i.status)return a.printToCreatorConsole("warn",a.validateString(i.msg)?`${i.msg} err_code: ${i.status}`:`绑定游戏失败 err_code: ${i.status}`),void 0}c.writeBindGame(this.game),"UNKNOW"!=e.appid&&(this.isBindGame=!0),window.ccServicesAnalytics&&window.ccServicesAnalytics.init(this.user.cocos_uid,this.game,this.service),window.ccServicesAnalytics&&window.ccServicesAnalytics.associateAppID(),this.isItemClickToBindGame?(this.isShowHome=!1,this.isShowService=!0,"0"===this.game.cid&&"2"===this.service.service_type?(a.printToCreatorConsole("warn",this.utils_t("select_company_service")),setTimeout(()=>{Editor.Dialog.messageBox({title:this.utils_t("dialog_title"),message:this.utils_t("select_company_service"),buttons:[this.utils_t("btn_ok")],defaultId:0,noLink:!0}),this.isShowHome=!0,this.isShowService=!1},1e3)):"0"!==this.game.cid&&"1"===this.service.service_type&&(a.printToCreatorConsole("warn",this.utils_t("select_persion_service")),setTimeout(()=>{Editor.Dialog.messageBox({title:this.utils_t("dialog_title"),message:this.utils_t("select_persion_service"),buttons:[this.utils_t("btn_ok")],defaultId:0,noLink:!0}),this.isShowHome=!0,this.isShowService=!1},1e3)),this.isShowService&&window.ccServicesAnalytics&&window.ccServicesAnalytics.enterService()):(this.isShowHome=!0,this.isShowService=!1),this.isShowBindGame=!1,this.isCompanyGame="0"!==this.game.cid,this.readEnableService()},readEnableService:function(){var e=c.readEnableService();for(var i of this.services)i.enable=e.indexOf(i.service_id)>=0,i.enable&&(t.serviceExists(i.service_component_name)||(a.printToCreatorConsole("warn",i.service_name+this.utils_t("service_not_install")),this.isDownloadServicePackage=!0,t.installServicePackage(i.package_download_url,i.service_component_name,e=>{this.downloadTip=e.text,this.isDownloadServicePackage=!1,this.$nextTick(()=>{this.isDownloadServicePackage=!0}),e.complete&&("failed"===e.text&&a.printToCreatorConsole("warn",this.utils_t("download_failed")),this.isDownloadServicePackage=!0,this.$nextTick(()=>{this.isDownloadServicePackage=!1}))})))},unbindGame:async function(){if(this.isBindGame=!1,""!==n){var e=await t.associateProjectID(this.game.appid,n,0);if(0!==e.status)return a.printToCreatorConsole("warn",a.validateString(e.msg)?`${e.msg} err_code: ${e.status}`:`解绑游戏失败 err_code: ${e.status}`),void 0}this.game={name:a.t("unknow_game"),appid:"UNKNOW"},c.writeBindGame(this.game),this.readEnableService(),window.ccServicesAnalytics&&window.ccServicesAnalytics.unassociateAppID(),window.ccServicesAnalytics&&window.ccServicesAnalytics.init(this.user.cocos_uid,this.game,this.service)},bindGame:function(){this.isShowHome=!1,this.isShowBindGame=!0,this.isItemClickToBindGame=!1,window.ccServicesAnalytics&&window.ccServicesAnalytics.enterBindCocosAppID()},enableService:function(e,i){for(var s of this.services)s.service_id===e&&(s.enable=i,c.wirteEnableService(e,s.enable))},watchFiles:function(e,i){var s=this.services;a.watch.createMonitor(e,t=>{t.on("removed",(t,a)=>{var c=t.substr(e.length+1);if(c.indexOf("/")<=-1)for(var o of s)if(o.service_component_name.indexOf(c)>=0)return i&&i(!0,o.service_id,o.service_name),void 0})})}}})},close(){Editor.User.removeListener("login",d),Editor.User.removeListener("logout",d)},listeners:{"panel-show"(){var e=c.readBindGame();e||(e={app_id:"UNKNOW"}),window.ccServicesAnalytics&&window.ccServicesAnalytics.init(t.getUserData().cocos_uid,e,{}),window.ccServicesAnalytics&&window.ccServicesAnalytics.openServicePanel()}},messages:{"cocos-services:before-change-files"(e,i){t.execInstallNativePlatformScript(i,i=>{1,e.reply&&e.reply(null,"Cocos Service install successfully")})}}});