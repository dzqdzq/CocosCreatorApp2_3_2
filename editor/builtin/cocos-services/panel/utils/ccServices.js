let e=require("./utils.js"),r=require("./network.js"),t=require("./serviceConfig.js"),i=require("fs");var s,a="https://creator-api.cocos.com/api/";"use strict";var o,n,c,d,l,v,p,u=!1,g=!1;Array.prototype.equals=function(e){if(!e)return!1;if(this.length!=e.length)return!1;for(var r=0,t=this.length;r<t;r++)if(this[r]instanceof Array&&e[r]instanceof Array){if(!this[r].equals(e[r]))return!1}else if(this[r]!=e[r])return!1;return!0},Object.defineProperty(Array.prototype,"equals",{enumerable:!1}),module.exports={async init(){if(console.log("ccServices init"),this.readServiceConfig(),!g){var r=`Cocos Service Version ${this.getServiceVersion()}`;console.log(r),u&&!Editor.isMainProcess&&e.printToCreatorConsole("info",r),g=!0}if((p=await Editor.User.isLoggedIn())||u){s=u?await this.userLogin():await this.getSessionID();var i=await this.getSessionToken();s.session_token=i.data.session_token;var a=await this.getUserInfo();for(var o in a.data)s[o]=a.data[o];l={data:t.readBindGame()},n=await this.getGameList(),d=await this.getTargetUrl(),c=await this.getServiceList(),t.writeServiceList(c.data)}else s={corporation_id:"0"},l={data:t.readBindGame()},null==(c={data:t.readServiceList()}).data&&(c=await this.getServiceList(),t.writeServiceList(c.data));v||(v=t.readEnableService())},readServiceConfig(){var e=t.readServiceConfig();if(this.readDevMode()){if(void 0===e.username||void 0===e.password)return;u=!0,a="https://test-creator-api.cocos.com/api/",o={username:e.username,password:e.password}}},readDevMode:()=>t.readDevMode(),writeDevMode(e){t.writeDevMode(e),e||this.init()},registerServiceComponent(r){var t=e.getCreatorHomePath()+"/services";if(r){var s=r.split("-")[1],a=t+"/"+s+"/pages/index.js";i.existsSync(a)&&(delete require.cache[require.resolve(a)],this.registerI18n(r),require(a))}else{if(!i.existsSync(t))return;i.readdirSync(t).forEach(e=>{var r=t+"/"+e,s=i.statSync(r);s&&s.isDirectory()&&i.existsSync(r+"/pages/index.js")&&(delete require.cache[require.resolve(r+"/pages/index.js")],this.registerI18n(`service-${e}`),require(r+"/pages/index.js"))})}},registerI18n(r){var t=e.getCreatorHomePath()+"/services",s=r.split("-")[1],a=t+"/"+s+`/pages/i18n/${e.getLang()}.js`;if(i.existsSync(a))try{delete require.cache[require.resolve(a)],Editor.i18n.extend({[`cocos-services.${s}`]:require(a)})}catch(e){}},readServicePackageInfo(r){var t=e.getCreatorHomePath()+"/services"+"/"+r.split("-")[1]+"/package.json";if(!i.existsSync(t))return{version:e.t("not_installed")};var s=e.readJson(t);return"zh"!==e.getLang()&&void 0!==s.upgrade_en&&(s.upgrade=s.upgrade_en,delete s.upgrade_en),s},readServiceVersionByURL(e){if(e){var r=e.split("/");return r[r.length-1].replace(".zip","")}return""},execInstallNativePlatformScript(r,s){this.readServiceConfig();var a=e.getCreatorHomePath()+"/services",o=t.readEnableService(),n=t.readServiceList();if(void 0===n)return e.printToCreatorConsole("warn","services not exists"),s(!0),void 0;if(!t.needExecNative())return s(!0),void 0;for(var c of(v||(v=o),this.backiOSPbxFile(r,!v.equals(o)),n)){var d=c.service_component_name.split("-")[1],l=a+"/"+d+"/install.js";if(i.existsSync(l)){var p=t.readServiceParam(c.service_id);try{delete require.cache[require.resolve(l)];var g=require(l);o.indexOf(c.service_id)>=0?g.onBuildedProjectEnable?(g.onBuildedProjectEnable(r,p),this.serviceIntegrationSubmit(c,"服务集成成功","Building Time")):u&&e.printToCreatorConsole("warn",`${e.t("must_dev_info_1")} ${c.service_name} SDK ${e.t("must_dev_info_install1")} -- ( onBuildedProjectEnable(options, params) {} )`):g.onBuildedProjectDisable?g.onBuildedProjectDisable(r,p):u&&e.printToCreatorConsole("warn",`${e.t("must_dev_info_1")} ${c.service_name} SDK ${e.t("must_dev_info_uninstall1")} -- ( onBuildedProjectDisable(options, params) {} )`)}catch(r){this.serviceIntegrationSubmit(c,"服务集成失败","Building Time",r.valueOf()),u&&e.printToCreatorConsole("warn",`${d}\n\t${r.valueOf()}`)}}}v=o,s(!0)},execInstallH5PlatformScript(r,t,s){this.readServiceConfig();var a=e.getCreatorHomePath()+"/services",o=r.service_component_name.split("-")[1],n=a+"/"+o+"/install.js";if(i.existsSync(n))try{delete require.cache[require.resolve(n)];var c=require(n);s?c.onServiceEnable?(c.onServiceEnable(e.getProjectPath(),t),this.serviceIntegrationSubmit(r,"服务集成成功","Editing Time")):u&&e.printToCreatorConsole("warn",`${e.t("must_dev_info_1")} ${r.service_name} JSSDK ${e.t("must_dev_info_install1")} -- ( onServiceEnable(projectPath, params) {} )`):c.onServiceDisable?c.onServiceDisable(e.getProjectPath(),t):u&&e.printToCreatorConsole("warn",`${e.t("must_dev_info_1")} ${r.service_name} JSSDK ${e.t("must_dev_info_uninstall1")} -- ( onServiceDisable(projectPath, params) {} )`)}catch(t){this.serviceIntegrationSubmit(r,"服务集成失败","Editing Time",t.valueOf()),u&&e.printToCreatorConsole("warn",`${o}\n\t${t.valueOf()}`)}},serviceIntegrationSubmit(e,r,i,a){var o={uid:s&&s.cocos_uid?s.cocos_uid:"",client_id:"CreatorServices",event:r,key_list:JSON.stringify(["app_id","app_name","service_id","service_name","time",a?"error":""]),value_list:JSON.stringify([t.readBindGame().appid,t.readBindGame().name,e.service_id?e.service_id:"",e.service_name?e.service_name:"",i,a?JSON.stringify(a):""])};this.submitLog(o)},serviceExists(r){var t=e.getCreatorHomePath()+"/services"+"/"+r.split("-")[1];return i.existsSync(t)},backiOSPbxFile(r,t){var s=r.dest+"/frameworks/runtime-src/proj.ios_mac/";if(i.existsSync(s)){var a=Date.parse(new Date);i.existsSync(s+"_backup/"+r.projectName+".xcodeproj")?t&&(i.renameSync(s+r.projectName+".xcodeproj",s+"_backup/"+r.projectName+"-"+a+".xcodeproj"),e.copyDir(s+"_backup/"+r.projectName+".xcodeproj",s+r.projectName+".xcodeproj")):e.copyDir(s+r.projectName+".xcodeproj",s+"_backup/"+r.projectName+".xcodeproj")}},installServicePackage(t,i,s){const a=require("fs");var o=e.getCreatorHomePath()+"/services/",n=e.getCreatorHomePath()+"/download/";!a.existsSync(o)&&e.mkdirs(o),!a.existsSync(n)&&e.mkdirs(n);var c,d=n+i+".zip";if(!t.match(".zip"))return s({text:"failed",complete:!0}),void 0;r.download(t,d,(r,i)=>{if(r)return s({text:"failed",complete:!0}),void 0;var n=e.t("downloading")+i.progress+"%";if(c!=i.progress&&(c=i.progress,s({text:n,complete:!1})),"complete"===i.status){if(100!==i.progress)return s({text:"failed",complete:!0}),void 0;e.unzip(d,o,r=>{r?s({text:"failed",complete:!0}):(s({text:e.t("installed"),complete:!0}),a.existsSync(t)&&a.unlinkSync(t))})}})},uninstallServicePackage(r){var t=e.getCreatorHomePath()+"/services/"+r.split("-")[1];e.removeDir(t)},getServicePackageDownloadUrl:(e,r)=>e.replace(/[0-9]+.[0-9]+.[0-9]+_[\x00-\xff]+.zip/,r+".zip"),async userLogin(){var t=a+"account/signin";return(await r.postAsync(t,{username:o.username,password:o.password,lang:e.getLang()})).data},async getSessionCode(){var e=a+"session/code",t={session_id:s.session_id};return await r.postAsync(e,this.paramPrase(t))},async openService(e,t,i){var o=a+"service/open",n={app_id:e,service_id:t,session_token:s.session_token};try{var c=await r.postAsync(o,this.paramPrase(n));i&&(0===c.status?i(!0):i(!1))}catch(e){i&&i(!1,e)}},async getSessionToken(){var e=a+"session/token",t={session_code:(await this.getSessionCode()).data.session_code,ip:"127.0.0.1"};return await r.postAsync(e,this.paramPrase(t))},async getServiceList(){var t=a+"service/lists";return await r.postAsync(t,{lang:e.getLang()})},async getGameList(){var e=a+"game/lists",t={session_token:s.session_token,ip:"127.0.0.1"},i=await r.postAsync(e,this.paramPrase(t));return n=i,i},async submitLog(e){var t=a+"log/add",i=this.paramPrase(e);await r.postAsync(t,i);u&&(e.submit_time=(new Date).toLocaleString(),console.log(e))},async getGameDetail(e){var t=a+"game/detail",i={session_token:s.session_token,ip:"127.0.0.1",app_id:e||l.data.app_id},o=await r.postAsync(t,this.paramPrase(i));return l=o,o},async getUserInfo(){var e=a+"user/info",t={session_token:s.session_token,ip:"127.0.0.1"};return await r.postAsync(e,this.paramPrase(t))},async getTargetUrl(){var e=a+"service/urls",t={session_token:s.session_token,ip:"127.0.0.1"};return await r.postAsync(e,this.paramPrase(t))},async associateProjectID(e,t,i){var o=a+"game/associate_project_id",n={session_token:s.session_token,ip:"127.0.0.1",app_id:e,project_id:t,action:i};return await r.postAsync(o,this.paramPrase(n))},getUserIsLogin:()=>p,getUserData(){return s||this.init(),s},async getUserDataAsync(){var e=await this.getUserInfo();for(var r in e.data)s[r]=e.data[r];return s},getGameLists(){return n||this.init(),n},getServiceLists(){return c||this.init(),c},getGame:()=>l||null,getUrl(r,t){if(!d)return e.printToCreatorConsole("warn",e.t("no_url_info")),"null data";var i,a=`${d.data.client_signin_url}session_id=${s.session_id}&redirect_url=`;return"dashboard"===r?i=a+d.data.cocos_dashboard_url:"create"===r?i=a+d.data.cocos_game_create_url:"service"===r?i=a+d.data.cocos_service_url:"enable_service"===r?i=a+encodeURIComponent(d.data.cocos_service_open_url+"?"+this.urlEncode(t).substring(1)):"person_verify"===r?i=a+d.data.cocos_personal_verify_url:"company_verify"===r?i=a+d.data.cocos_company_verify_url+"?"+this.urlEncode(t).substring(1):"person_bind_phone"===r?i=a+d.data.cocos_mobile_bind_personal_url:"company_bind_phone"===r&&(i=a+d.data.cocos_mobile_bind_company_url),i},async getSessionID(){if(Editor.User.getUserData&&"function"==typeof Editor.User.getUserData){var r=await Editor.User.getUserData();if(r.session_id)return r}return e.readJson(`${e.getCreatorHomePath()}/profiles/user_token.json`)},getServiceVersion:()=>e.readJson(Editor.url("packages://cocos-services/package.json")).version,getDisplayVersion:()=>Editor.remote.versions.CocosCreator,paramPrase(r){var t=require("md5"),i=r;i.plugin_id="1025",i.lang=e.getLang(),i=this.objKeySort(i);var s=this.urlEncode(i)+"&32104adac01fdec28ac19df0b2f42d532b06311d";return i.sign=t(s.substr(1)),i},urlEncode(e,r,t){if(null==e)return"";var i="",s=typeof e;if("string"==s||"number"==s||"boolean"==s)i+="&"+r+"="+(t?encodeURIComponent(e):e);else for(var a in e){var o=null==r?a:r+(e instanceof Array?"["+a+"]":"."+a);i+=this.urlEncode(e[a],o,t)}return i},objKeySort(e){for(var r=Object.keys(e).sort(),t={},i=0;i<r.length;i++)t[r[i]]=e[r[i]];return t}};