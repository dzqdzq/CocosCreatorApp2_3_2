const e=require("path"),n=(require("fs"),require("gulp")),r=(require("gulp-sourcemaps"),require("babelify")),i=require("browserify"),s=require("vinyl-source-stream"),o=(require("gulp-uglify"),require("vinyl-buffer"));require("async");function t(e){let n=CocosEngine,r=parseInt(e.replace(/[^\d]/g,""));return parseInt(n.slice(0,6).replace(/[^\d]/g,""))>=r}const a={build:async function(a){let{isTinyPackage:u,rootPath:l,dstPath:p,excludedModules:c}=a;if(!l)throw new Error("Please specify the jsbAdapter path");console.time("build jsb-adapter"),await new Promise(a=>{let d=[];if(c&&c.length>0){let n=require(Editor.url("packages://jsb-adapter/modules.json"));c.forEach(function(r){n.some(function(n){if(n.name===r&&n.entries)return n.entries.forEach(function(n){d.push(e.join(l,n))}),!0})})}let j=[e.join(l,"./engine/index.js")];!0===t("2.4.0")?(j.push(e.join(l,"engine","jsb-audio2.4.js")),j.push(e.join(l,"engine","jsb-loader2.4.js"))):(j.push(e.join(l,"engine","jsb-audio.js")),j.push(e.join(l,"engine","jsb-loader.js"))),!0===u&&(!0===t("2.4.0")?j.push(e.join(l,"engine","cache-manager.js")):j.push(e.join(l,"rt-adapter.js"))),function(t,a,u){let l=e.basename(a);a=e.dirname(a);let p=i();t.forEach(function(e){p.add(e)}),u&&u.forEach(function(e){p.exclude(e)});let c=CocosEngine,d=parseInt("2.3.0".replace(/[^\d]/g,"")),j="env";return 1==parseInt(c.slice(0,6).replace(/[^\d]/g,""))>=d&&(j=require("@babel/preset-env")),p.transform(r,{presets:[j]}).bundle().pipe(s(l)).pipe(o()).pipe(n.dest(a))}(j,e.join(p,"engine","index.js"),d).on("end",a)}),console.timeEnd("build jsb-adapter")}};module.exports=a;