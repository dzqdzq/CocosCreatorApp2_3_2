let e=require("./jszip.min.js"),i=require("path"),t=require("fs-extra"),a=require("./worker-util.js"),n=require("./adapter-util.js"),r=require("./tinypack-util.js"),o={};e.prototype.directory=function(e,a){if(!t.statSync(e).isDirectory())return Editor.error(e+" is not a folder!"),void 0;t.readdirSync(e).forEach(function(e){let a=this.zip,n=i.join(this.srcPath,e),r=t.statSync(n);r.isDirectory()?a.directory(n,e):r.isFile()?a.file(e,t.readFileSync(n)):Editor.error(n+" was not added to zip!")}.bind({srcPath:e,zip:this.folder(a)}))},e.prototype.append=function(e,i){if(!t.statSync(e).isFile())return Editor.error(e+" is not a file!"),void 0;this.file(i,t.readFileSync(e))},module.exports={async gatherInfo(s){void 0!==Editor.Profile.load.getSelfData?o.customConfig=Editor.Profile.load("project://cpk-publish.json").getSelfData():o.customConfig=Editor.Profile.load("profile://project/cpk-publish.json").data;let c=o.customConfig;o.isTinyPackage=!!c.tinyPackageMode,o.projectPath=s.project,o.buildPath=s.dest,o.options=s,o.title=s.title,o.cpkName=s.title+".cpk";let d=c.outputCpkPath,p=c.useCustomCpkPath;o.buildResults=s.buildResults,o.startScene=s.startScene,!0===p?""!==d&&t.existsSync(d)?o.cpkPath=i.join(d,o.cpkName):(Editor.log(Editor.T("cpk-publish.out_cpk_path_error")),o.cpkPath=i.join(o.buildPath,o.cpkName)):o.cpkPath=i.join(o.buildPath,o.cpkName),o.gameConfig={deviceOrientation:c.deviceOrientation,showStatusBar:c.showStatusBar,runtimeVersion:c.runtimeVersion},o.JsZip=e,o.cpk=new e,await a.gatherInfo(o),await n.gatherInfo(o),await r.gatherInfo(o)},async organizeResources(e){let r=o.buildPath;return await a.organizeResources(),!1!==await n.organizeResources(e)&&(t.writeFileSync(i.join(r,"game.config.json"),JSON.stringify(o.gameConfig)),this.handleMainJS(),!0)},handleMainJS(){var e=i.join(o.buildPath,"main.js"),a=t.readFileSync(e,"utf8");a=r.getAdaptTinyModeInMainJs(a),a=this.getLandscapeData(a),t.writeFileSync(e,a)},getLandscapeData(e){if("landscape"!==o.customConfig.deviceOrientation)return e;var i="require('jsb-adapter/engine/index.js');",t=e.indexOf(i)+i.length;return e=e.slice(0,t)+"\n\t\tloadRuntime().callCustomCommand({}, 'setOrientation', '{\"orientation\":0}');\n\t\twindow.orientation = 90;"+e.slice(t)},async pack(){let e=o.cpk,s=o.cpkPath,c=o.buildPath;t.existsSync(s)&&t.unlinkSync(s);let d=t.createWriteStream(s);await a.pack(),await n.pack(),await r.pack(),e.directory(i.join(c,"src"),"src"),e.append(i.join(c,"main.js"),"main.js"),e.append(i.join(c,"game.config.json"),"game.config.json"),e.generateNodeStream({type:"nodebuffer",base64:!1,compression:"DEFLATE"}).pipe(d).on("finish",function(){r.packFinished()})}};