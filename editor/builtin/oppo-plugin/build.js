var e="manifest.json",r=require("path"),i=require("fs-extra"),{exec:o,execSync:t}=require("child_process"),n=require("fix-path");let a;var s,p,c,d,u,l,m,f,v,g,y,_="sign",E="logo.png",j={},S="win32"===process.platform;function k(e){let i=Editor.url("packages://oppo-adapter");return void 0===e||""===e?i:r.join(i,e)}function b(){return r.join(Editor.url("packages://oppo-adapter/quickgame-toolkit/lib/bin"),"index")}function h(f,h){if(Editor.log("Checking config file "+h.dest),a.npmPath){isFixPath=!1,Editor.log(Editor.T("oppo-runtime.custom_npm_path_config"),a.npmPath);let e=r.join(Editor.url("packages://oppo-runtime/quickgame-toolkit"),"lib","bin");S?(j.Path=a.npmPath,j.Path+=";"+e):(j.PATH=a.npmPath,j.PATH+=":"+e)}else v&&Editor.log(Editor.T("oppo-runtime.custom_npm_path_not_config")),n(),j=process.env;!1!==function(){try{t("node -v",{env:j})}catch(e){return a.npmPath?(f.reply(new Error(Editor.T("oppo-runtime.custom_npm_path_config_error"))),void 0):(Editor.Ipc.sendToWins("builder:events","npmPath-show"),S&&f.reply(new Error(Editor.T("oppo-runtime.not_install_nodejs_windows_error"))),f.reply(new Error(Editor.T("oppo-runtime.not_install_nodejs_mac_error"))),!1)}return!0}()&&(s=r.resolve(h.dest,"..","tempTinyRes"),p=h.dest,d=function(e){var i;if(y=e.buildResults._subpackages,"{}"==JSON.stringify(y))i=void 0;else for(var o in i=[],y){var t=y[o].path,n=r.extname(t),a=r.basename(t,n),s={name:a,root:"subpackages/"+a+"/"};i.push(s)}return i}(h),function(){if(!a.tinyPackageMode)return;var e=r.join(p,"res"),o=r.join(s,"res");i.existsSync(o)&&i.removeSync(o);i.copySync(e,o);try{i.removeSync(e)}catch(r){i.emptyDirSync(e)}}(),i.writeFileSync(r.join(p,E),i.readFileSync(c)),function(){var e=r.join(p,_);if(i.emptyDirSync(e),!m){var o=r.join(e,"release");i.ensureDirSync(o),i.existsSync(u)&&i.writeFileSync(r.join(o,"private.pem"),i.readFileSync(u)),i.existsSync(l)&&i.writeFileSync(r.join(o,"certificate.pem"),i.readFileSync(l))}}(),function(o){var t=r.join(p,e),n={package:a.package,name:a.name,versionName:a.versionName,versionCode:a.versionCode,minPlatformVersion:a.minPlatformVersion,icon:"/logo.png",features:[{name:"system.prompt"},{name:"system.router"},{name:"system.shortcut"}],permissions:[{origin:"*"}],orientation:a.deviceOrientation};d&&(n.subpackages=d);var s=JSON.stringify(n);i.writeFileSync(t,s)}(),async function(){let e=require("./build-jsb-adapter"),t=r.join(k(),"engine","index.js");!0===a.tinyPackageMode&&(t=r.join(k(),"engine","index_tiny_mode.js"));let n=r.join(r.join(p,"jsb-adapter"),"engine","index.js");await e.build({rootPath:t,dstPath:n,isDebug:g.debug}),function(e,o){if(!1===a.tinyPackageMode)return;var t=a.tinyPackageServer;if(""===t)return f.reply(new Error("please enter remote server root")),void 0;let n=r.join(r.join(o,"jsb-adapter"),"engine","index.js");var p=i.readFileSync(n,"utf8");p=p.replace("REMOTE_SERVER_ROOT_PLACE_HOLDER",t),i.writeFileSync(n,p),!0===a.packFirstScreenRes&&function(e){let o=e.buildResults;var t=o.getDependencies(e.startScene),n=r.join(s,"res","import");i.copySync(n,r.join(e.dest,"res","import")),i.removeSync(n);for(var a=0;a<t.length;++a){var p=t[a],c=o.getNativeAssetPath(p);if(!c||0===c.length)continue;let n=r.join(e.dest,c.replace(e.dest,""));if(n.indexOf("\\subpackages")>-1){Editor.log(Editor.T("oppo-runtime.pack_res_to_first_pack_contain_subpack_res_error"));continue}let u=r.join(s,c.replace(e.dest,""));i.moveSync(u,n);var d=r.dirname(u);i.existsSync(d)&&0===i.readdirSync(d).length&&i.removeSync(d)}}(e)}(g,p),function(e,o){if(!function(){if("{}"==JSON.stringify(y))return!1;return!0}())return function(e,i){var o="node "+b();Editor.log(Editor.T("oppo-runtime.rpk_installing"));var t=`${o}  cocoscreator`;i(`${t+=m?"":" release"}`,{env:j,cwd:p},i=>{if(i)return e.reply(new Error(Editor.T("oppo-runtime.rpk_install_fail")+i)),void 0;var o=r.join(p,"dist",a.package+(m?".":".signed.")+"rpk");Editor.log(Editor.T("oppo-runtime.rpk_install_success")+o),P(),e.reply(),T()})}(e,o),void 0;Editor.log(Editor.T("oppo-runtime.building_subpack_rpk"));var t=r.join(p,"subpackages");if(i.existsSync(t))for(var n in d){var s=r.join(p,d[n].root,"index.js"),c=r.join(p,d[n].root,"main.js");i.existsSync(s)&&i.renameSync(s,c)}(function(e,i){var o=`${"node "+b()} subpack --no-build-js`;m||(o+=" release");i(`${o}`,{env:j,cwd:p},i=>{if(i)return e.reply(new Error(Editor.T("oppo-runtime.build_subpack_rpk_error")+i)),void 0;var o=r.join(p,"dist",a.package+(m?".":".signed.")+"rpk");Editor.log(Editor.T("oppo-runtime.build_subpack_rpk_complet")+o),P(),e.reply(),T()})})(e,o)}(f,o)}())}function P(){var e=r.join(s,"res"),o=r.join(p,"res");a.tinyPackageMode&&i.existsSync(s)&&(i.emptyDirSync(o),i.copySync(e,o)),i.existsSync(s)&&i.removeSync(s)}function T(){var e=CocosEngine,r=parseInt("2.2.1".replace(/[^\d]/g,""));if(!0===parseInt(e.slice(0,6).replace(/[^\d]/g,""))>=r){var i;let e={resUrl:(i=void 0!==Editor.Profile.load.getSelfData?Editor.Profile.load("project://oppo-runtime.json").getSelfData():Editor.Profile.load("profile://project/oppo-runtime.json").data).tinyPackageServer,orientation:i.deviceOrientation,projectName:i.name};return Editor.Ipc.sendToMain("builder:notify-build-result",g,e),void 0}!0===a.useDebugKey||a.package.indexOf("test")>-1||a.name.indexOf("test")>-1||!0===f||Editor.Metrics.trackEvent("Project","BetaPlatforms","oppo-runtime",{packageName:a.package,appName:a.name,version:a.versionName,orientation:a.deviceOrientation})}module.exports={name:Editor.T("oppo-runtime.platform_name"),platform:"quickgame",extends:"runtime",buttons:[Editor.Builder.DefaultButtons.Build,{label:Editor.T("BUILDER.play"),message:"play"}],messages:{"build-start":function(e,r){i.existsSync(r.dest)&&i.emptyDirSync(r.dest),e.reply()},"build-finished":function(e,r){var o;g=r,void 0!==Editor.Profile.load.getSelfData?(o=Editor.Profile.load("project://oppo-runtime.json"),a=o.getSelfData()):(o=Editor.Profile.load("profile://project/oppo-runtime.json"),a=o.data);var t=a.package,n=a.name,s=a.versionName,p=a.versionCode,d=a.minPlatformVersion;v=a.showNpmPath,u=a.privatePath,l=a.certificatePath,m=a.useDebugKey,c=a.icon,f=r.debug,sendStatisticsSourceMaps=r.sourceMaps;var y=!0,_=[],E="";if([{name:Editor.T("oppo-runtime.package"),value:t},{name:Editor.T("oppo-runtime.name"),value:n},{name:Editor.T("oppo-runtime.desktop_icon"),value:c},{name:Editor.T("oppo-runtime.version_name"),value:s},{name:Editor.T("oppo-runtime.version_number"),value:p},{name:Editor.T("oppo-runtime.support_min_platform"),value:d}].forEach(function(e){e.value||(y=!1,_.push(e.name))}),y||(E+=_.join("„ÄÅ")+Editor.T("oppo-runtime.not_empty")),c&&(i.existsSync(c)||(y=!1,E+=c+Editor.T("oppo-runtime.icon_not_exist"))),m||(""===u?(y=!1,E+=Editor.T("oppo-runtime.private_pem_path_error")):i.existsSync(u)||(y=!1,E+=`${u}`+Editor.T("oppo-runtime.signature_not_exist")),""===l?(y=!1,E+=Editor.T("oppo-runtime.certificate_pem_path_error")):i.existsSync(l)||(y=!1,E+=`${l}`+Editor.T("oppo-runtime.signature_not_exist"))),t.match(/^[a-zA-Z]+[0-9a-zA-Z_]*(\.[a-zA-Z]+[0-9a-zA-Z_]*)*$/)||(y=!1,E+=Editor.T("oppo-runtime.package_name_error")),!y)return e.reply(new Error(E)),void 0;h(e,r)}},settings:Editor.url("packages://oppo-runtime/build-ui.js")};