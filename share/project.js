"use strict";const e=require("fire-path"),r=require("fire-fs"),o=require("lodash"),i=require("semver"),{shell:n}=require("electron"),t=require("node-uuid"),s=Editor.Profile.load("global://settings.json");let c={};module.exports=c,c.create=function(o,i,n){let s=Editor.dev?Editor.url("app://"):e.join(Editor.url("app://"),"..","..");if(Editor.log("install path: "+s),e.contains(s,o))return n&&n(new Error(Editor.T("DASHBOARD.error_project_in_install"))),void 0;if(r.existsSync(o))return n&&n(new Error("The path "+o+" already exists.")),void 0;let c=function(i){r.copy(Editor.url("unpack://utils/api/creator.d.ts"),e.join(o,"creator.d.ts"),n=>{n&&Editor.log(n),r.copy(Editor.url("unpack://utils/vscode-extension/jsconfig.json"),e.join(o,"jsconfig.json"),e=>{e&&Editor.log(e),i(e)})})},a=e.join(o,"project.json");if(i)process.env.checkedVersion=!0,r.copy(i,o,e=>{e&&console.log(e);try{let e=r.readFileSync(a,"utf8");(e=JSON.parse(e)).id=t.v4(),r.writeFileSync(a,JSON.stringify(e,null,2))}catch(e){console.error(e)}c(n)});else{r.mkdirsSync(o),r.mkdirSync(e.join(o,"settings")),r.mkdirSync(e.join(o,"local")),r.mkdirSync(e.join(o,"packages")),r.mkdirSync(e.join(o,"assets")),r.mkdirSync(e.join(o,"library"));let i={engine:"cocos-creator-js",packages:"packages",version:Editor.versions.CocosCreator,id:t.v4()};r.writeFileSync(a,JSON.stringify(i,null,2)),r.copySync(Editor.url("unpack://templates/hello-world/.gitignore"),e.join(o,".gitignore")),c(n)}},c.add=async function(e){await s.reset();let r=s.get("recently-opened"),o=r.indexOf(e);-1!==o&&r.splice(o,1),r.unshift(e),s.set("recently-opened",r),s.save()},c.delete=function(e){c.remove(e),n.moveItemToTrash(e)},c.remove=async function(e){await s.reset();let r=s.get("recently-opened");o.remove(r,function(r){return r===e}),s.set("recently-opened",r),s.save()},c.check=function(o,n){if(!1===r.existsSync(o))return n&&n(new Error("Project not exists!")),void 0;let t=Editor.dev?Editor.url("app://"):e.join(Editor.url("app://"),"..","..");if(e.contains(t,o))return n&&n(new Error(Editor.T("DASHBOARD.error_project_in_install_open"))),void 0;c.getInfo(o,function(t){if(!t)return n&&n(new Error("Can not find project.json")),void 0;if(t.error)return n&&n(new Error(t.error)),void 0;let s=t.project;if(s&&(!process.env.checkedVersion||"false"===process.env.checkedVersion)&&!Editor.argv.force){let e=s.version,r=!e,c=r||i.satisfies(e,"<"+Editor.versions.CocosCreator,{includePrerelease:!0}),a=e&&i.satisfies(e,">"+Editor.versions.CocosCreator,{includePrerelease:!0});if(c||a){let i="MESSAGE.check_project_version.degrade";if(c&&(i=r?"MESSAGE.check_project_version.upgrade_before_v2_1_2":"MESSAGE.check_project_version.upgrade"),1===Editor.Dialog.messageBox({type:"question",buttons:[Editor.T("MESSAGE.confirm"),Editor.T("SHARED.exit")],message:Editor.T(i,{projectVer:e,editorVer:Editor.versions.CocosCreator,projectPath:o}),defaultId:1,cancelId:1,noLink:!0}))return t.abort=!0,n&&n(null,t),void 0}}process.env.checkedVersion=!0;let c=e.join(o,"settings");r.existsSync(c)||r.mkdirSync(c),c=e.join(o,"local"),r.existsSync(c)||r.mkdirSync(c),c=e.join(o,"packages"),r.existsSync(c)||r.mkdirSync(c),c=e.join(o,"assets"),r.existsSync(c)||r.mkdirSync(c),c=e.join(o,"library"),r.existsSync(c)||r.mkdirSync(c),n&&n(null,t)})},c.getInfo=function(o,i){let n,t=e.join(o,"project.json");if(!1===r.existsSync(t))return i&&i(),void 0;try{n=JSON.parse(r.readFileSync(t,"utf8"))}catch(r){return i&&i({path:o,name:e.basename(o),engine:"unknown",project:n,error:"project.json broken: "+r.message,abort:!1}),void 0}i&&i({id:n.id||"",path:o,name:e.basename(o),project:n,abort:!1})};