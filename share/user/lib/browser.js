"use strict";const e=require("../../@base/electron-base-ipc"),t=process.send?require("@editor/user/dist/platform/child"):require("@editor/user"),{EventEmitter:o}=require("events"),{shell:r}=require("electron");let a=Editor.Profile.load("global://user_token.json"),i="",n=async function(e){let o=await t.getData(),r=module.exports.enable(),a=o.nickname||i,n=`${Editor.T("SHARED.help")}/${Editor.T("MAIN_MENU.account.none")}`,s=`${Editor.T("SHARED.help")}/${Editor.T("MAIN_MENU.account.logged_user",{username:a})}`,l=`${Editor.T("SHARED.help")}/${Editor.T("MAIN_MENU.account.logout")}`;i=o.nickname,Editor.MainMenu.exists(n)&&Editor.MainMenu.remove(n),Editor.MainMenu.exists(s)&&Editor.MainMenu.remove(s),Editor.MainMenu.exists(l)&&Editor.MainMenu.remove(l),e?(Editor.MainMenu.add(Editor.T("SHARED.help"),{label:Editor.T("MAIN_MENU.account.logged_user",{username:a}),enabled:r,visible:!!a&&r}),Editor.MainMenu.add(Editor.T("SHARED.help"),{label:Editor.T("MAIN_MENU.account.logout"),click(){module.exports.logout()},enabled:r})):Editor.MainMenu.add(Editor.T("SHARED.help"),{label:Editor.T("MAIN_MENU.account.none"),enabled:!1})};!process.send&&t.on("info-update",()=>{a.clear(),a.set(null,t.getData()),a.save()});let s=module.exports=new class extends o{constructor(){super(),this._enable=!0,this._preUserId=null,t.setData&&t.setData(a.get(null)),this.isLoggedIn()}enable(t){return void 0!==t&&(this._enable=!!t,e.broadcast("creator-lib-user:flag","_enable",this._enable)),this._enable}async isLoggedIn(e){const o=await t.isLoggedIn();return n(o),o}async login(e,o){return await t.login(e,o)}async logout(){return await t.logout()}async getUserToken(){return await t.getUserToken()}async getSessionCode(e,o){return o&&Editor.warn("'getSessionCode' returns a standard 'promise' , please use 'await' to wait for the data"),await t.getSessionCode(e)}async getUserData(){return await t.getData()}async redirect(e){e=`https://creator-api.cocos.com/api/account/client_signin?session_id=${(await t.getData()).session_id}&redirect_url=${e}`,r.openExternal(e)}async getUserId(){return(await t.getData()).cocos_uid}};t.on("login",()=>{s.emit("login"),e.broadcast("creator-lib-user:emit","login"),n(!0)}),t.on("logout",()=>{s.emit("logout"),e.broadcast("creator-lib-user:emit","logout"),n(!1)}),e.on("creator-libs-user:call",async(e,t,...o)=>{let r,a=s[t];try{r=await a.call(s,...o)}catch(t){return e.reply(t.message,null)}e.reply(null,r)}),e.on("creator-lib-user:query",(e,t)=>module.exports[t]),t.on("login",()=>{module.exports.emit("login"),e.broadcast("creator-lib-user:emit","login")}),t.on("waiting",()=>{module.exports.emit("waiting"),e.broadcast("creator-lib-user:emit","waiting")}),t.on("logout",()=>{module.exports.emit("logout"),e.broadcast("creator-lib-user:emit","logout")}),t.on("exception",t=>{module.exports.emit("exception",t),e.broadcast("creator-lib-user:emit","exception",t)});